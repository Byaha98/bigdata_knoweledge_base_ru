

ÐÑƒ Ð½Ð°ÐºÐ¾Ð½ÐµÑ†-Ñ‚Ð¾ Ð³Ð°Ð¹Ð´ Ð¿Ð¾ Airflow+DBT!ðŸ’ª

  

ÐŸÑ€Ð¾ÑˆÐ»Ñ‹Ðµ ÑÑ‚Ð°Ñ‚ÑŒÐ¸ Ð² Ñ€Ð°Ð¼ÐºÐ°Ñ… Ð´Ð¾Ð¼Ð°ÑˆÐ½ÐµÐ³Ð¾ Ð¿Ð¾Ð»Ð¸Ð³Ð¾Ð½Ð° Ð´Ð°Ñ‚Ð° Ð¸Ð½Ð¶ÐµÐ½ÐµÑ€Ð¸Ð¸ Ð¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸:

  

ÐšÐ°Ðº Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ WSL, docker Ð¸ ÑƒÐ±ÑƒÐ½Ñ‚Ñƒ Ð² Ð½ÐµÐ³Ð¾ Ð¸ Dbeaver Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð‘Ð” 
[[1 Ð§Ð°ÑÑ‚ÑŒ Dbeaver Docker WSL Ubuntu]]
ÐšÐ°Ðº Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ñƒ ÑÐµÐ±Ñ Clickhouse Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾:Â 
[[2 Ð§Ð°ÑÑ‚ÑŒ Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð´Ð½ÑÑ‚Ð¸Ðµ Clickhouse]]
ÐšÐ°Ðº Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ VS code Ð¸ WSL Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ð½Ð° Ð¿Ð¾Ð»Ð¸Ð³Ð¾Ð½Ðµ
[[3 Ð§Ð°ÑÑ‚ÑŒ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° WSL Ð¸ VS code Ðº Ð¿Ð¾Ð»Ð¸Ð³Ð¾Ð½Ñƒ]]

  

Ð˜Ñ‚Ð°Ðº, Airflow Ñ DBT Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ð±ÑƒÐ´ÐµÐ¼ Ð¿Ð¾Ð´Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Docker compose. Ð¨Ð¾ ÑÑ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ?


docker-compose â€” ÑÑ‚Ð¾ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² ÑÑ€Ð°Ð·Ñƒ, Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð¾Ð´Ð½Ð¾Ð³Ð¾ YAML-Ñ„Ð°Ð¹Ð»Ð° (docker-compose.yml).


Ð’Ð¼ÐµÑÑ‚Ð¾ Ñ‚Ð¾Ð³Ð¾ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð¿Ð¾ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¿Ñ€Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°Ñ‚ÑŒ ÐºÑƒÑ‡Ñƒ ÐºÐ¾Ð¼Ð°Ð½Ð´, Ñ‚Ñ‹ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑˆÑŒ, Ñ‡Ñ‚Ð¾ Ð¸ ÐºÐ°Ðº Ð½ÑƒÐ¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ, Ð² Ð¾Ð´Ð½Ð¾Ð¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ðµ.

  

ÐŸÑ€Ð¸Ð¼ÐµÑ€:

Ð¥Ð¾Ñ‡ÐµÑˆÑŒ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Airflow? ÐžÐ½ ÑÐ¾ÑÑ‚Ð¾Ð¸Ñ‚ Ð¸Ð· Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… Ñ‡Ð°ÑÑ‚ÐµÐ¹:

  

1. web-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ (UI),

  

2. scheduler (Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸Ðº),

  

3. Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…

  

Ð­Ñ‚Ð¾ ÐºÐ°Ðº Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ðŸ˜“

  

Ð¡ docker-compose Ñ‚Ñ‹ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¸ÑˆÐµÑˆÑŒ, ÐºÐ°Ðº Ð²ÑÑ‘ ÑÑ‚Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð²Ð¼ÐµÑÑ‚Ðµ â€” Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑˆÑŒ Ð¾Ð´Ð½Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹.ðŸ¦‹

  

Ð—Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð² Ð½Ð°Ñˆ Workspace Ð² Vs Code Ð¸Ð· Ð¿Ñ€Ð¾ÑˆÐ»Ð¾Ð³Ð¾ Ð³Ð°Ð¹Ð´Ð° Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð´Ð¾ÐºÐµÑ€ ÐºÐ¾Ð¼Ð¿Ð¾Ð·Ð° (Ð¸Ð·Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾ Ñ Ð½Ð°Ð·Ð²Ð°Ð» ÐµÐµ docker_folder, Ð½Ð¾ Ð»ÑƒÑ‡ÑˆÐµ Ð½Ð°Ð²ÐµÑ€Ð½Ð¾Ðµ airflow_dbt Ð½Ð°Ð·Ð²Ð°Ñ‚ÑŒ Ð¸Ð»Ð¸ ÐºÐ°Ðº-Ñ‚Ð¾ Ñ‚Ð°Ðº)Â 

  

Ð’ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð°Ð¿ÐºÐ¸, Ð½Ð¾ Ð¿Ñ€Ð¸ ÑÑ‚Ð¾Ð¼ Ð²Ñ‹ Ñ€Ð°Ð½ÐµÐµ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ð»Ð¸ Ð¸Ð· ÑÑ‚Ð°Ñ€Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, Ð¿Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¸ ÑÐµÑ‚Ð¸ Ð¾Ñ‚ ÑÑ‚Ð°Ñ€Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸: 

```
docker compose -p docker_folderÂ  down --volumes
```

ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ poligon Ð¸Ð· Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ð°:
  
```
su konstantin
```
  
Ð¢ÑƒÑ‚ Ð¿Ð¾Ð½ÑÑ‚Ð½Ð¾, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð²Ð°Ñˆ ÑŽÐ·ÐµÑ€ Ð±ÑƒÐ´ÐµÑ‚,Â  Ñƒ Ð¼ÐµÐ½Ñ Ð² Ð´Ð°Ð½Ð½Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ konstantin

Ð”ÐµÐ»Ð°ÐµÐ¼ Ð½Ð°ÑˆÑƒ Ð¿Ð°Ð¿ÐºÑƒ:


```
mkdir docker_folder
```
  

Ð”Ð°Ð»ÐµÐµ Ð²Ð²Ð¾Ð´Ð¸Ð¼ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ ÐºÐ¾Ð¼Ð°Ð½Ð´ (ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð¿Ð¾ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸) Ð´Ð»Ñ Ñ€ÐµÐºÑƒÑ€ÑÐ¸Ð²Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð½Ð°ÑˆÐµÐ³Ð¾ ÑŽÐ·ÐµÑ€Ð° ÐºÐ¾ Ð²ÑÐµÐ¼Ñƒ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð¼Ñƒ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð¼Ñƒ Ð¿Ð°Ð¿ÐºÐ¸:

```
sudo chown -R konstantin:konstantin /home/konstantin/poligon/docker_folder
```
```
sudo apt install acl
```
```
chmod g+s /home/konstantin/poligon/docker_folder
```
```
sudo setfacl -R -m u:konstantin:rwx,g:konstantin:rwx /home/konstantin/poligon/docker_folder
```
```
sudo setfacl -R -d -m u:konstantin:rwx,g:konstantin:rwx /home/konstantin/poligon/docker_folder
```
![[poligon_airflow_dbt_1.png]]
Ð­Ñ‚Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´ÐµÐ»Ð°ÑŽÑ‚ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐµ:


1. Ð ÐµÐºÑƒÑ€ÑÐ¸Ð²Ð½Ð¾ Ð½Ð°Ð·Ð½Ð°Ñ‡Ð°ÑŽÑ‚ Ð²Ð°Ñ (konstantin Ð² Ð¼Ð¾ÐµÐ¼ ÑÐ»ÑƒÑ‡Ð°Ðµ) Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†ÐµÐ¼ Ð²ÑÐµÑ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸ Ð¿Ð°Ð¿Ð¾Ðº.

2. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽÑ‚ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ñ€Ð°Ð² (ACL), Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð±Ñ‹Ð»Ð¾ Ð³Ð¸Ð±ÐºÐ¾ Ð·Ð°Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ.

3. Ð’ÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‚ setgid, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑƒÐ½Ð°ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð»Ð¸ Ð½ÑƒÐ¶Ð½ÑƒÑŽ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ.

4. Ð¡ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ACL Ð´Ð°ÑŽÑ‚ Ñ‚ÐµÐ±Ðµ Ð¸ Ñ‚Ð²Ð¾ÐµÐ¹ Ð³Ñ€ÑƒÐ¿Ð¿Ðµ Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼ Ð¸ Ð»ÑŽÐ±Ñ‹Ð¼ Ð±ÑƒÐ´ÑƒÑ‰Ð¸Ð¼ Ñ„Ð°Ð¹Ð»Ð°Ð¼ Ð² Ð¿Ð°Ð¿ÐºÐµ.

  

Ð”Ð°Ð»ÐµÐµ Ð² Ð¿Ð°Ð¿ÐºÐµ:


Ð’ Ð½ÐµÐ¹ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð½ÐµÑ…Ð¸Ñ‚Ñ€Ñ‹Ð¼ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÐµÐ¼ Dockerfile(Ð±ÐµÐ· Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ .)


Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ„Ð°Ð¹Ð» ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ñ‹Ð¼:

```
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð· Apache Airflow Ð²ÐµÑ€ÑÐ¸Ð¸ 3.0.3 ÐÐžÐ’Ð•Ð™Ð¨Ð˜Ð™ Ð”Ð«ÐÐÐÐ

FROM apache/airflow:3.0.3

#1000-Ð­Ñ‚Ð¾ Ð½Ð°Ñˆ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ Ñ…Ð¾ÑÑ‚Ð¾Ð²Ð¾Ð¹ Ð¼Ð°ÑˆÐ¸Ð½Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Airflow Ð¸ DBT

#Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ð½Ðµ Ð·Ð½Ð°ÐµÑ‚Ðµ ÑÐ²Ð¾Ð¹ UID, Ñ‚Ð¾ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð² Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ id Ð¸ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð½Ð° Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ UID

USER root

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹

RUN apt-get update && apt-get install -y git

  

# Ð—Ð°Ð´Ð°Ñ‘Ð¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ñ‹ Ð´Ð»Ñ ÑŽÐ·ÐµÑ€Ð¾Ð² airflow Ð¸ default (UID 1000) Ð´Ð»Ñ /opt/dbt Ð¸ /opt/airflow

RUN mkdir -p /opt/dbt /opt/airflow/logs \

Â Â Â Â && chown -R 1000:1000 /opt/dbt /opt/airflow \

Â Â Â Â && chown -R airflow /opt/dbt /opt/airflow

USER 1000

#ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¾Ñ€Ð° ÐºÐ¾Ð´Ð° Ð´Ð»Ñ Airflow DAGs

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° DBT Ð¸ ClickHouse-Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹

RUN pip install --no-cache-dir \

Â Â Â Â airflow-code-editor==8.0.1 \

Â Â Â Â black isort fs-s3fs \

Â Â Â Â dbt-core==1.10.4 \

Â Â Â Â dbt-clickhouse==1.9.2 \

Â Â Â Â airflow-clickhouse-plugin==1.5.0

  

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑˆÐ°Ð±Ð»Ð¾Ð½ profiles.yml ÐžÐ± ÑÑ‚Ð¾Ð¼ Ñ„Ð°Ð¹Ð»Ðµ Ð¿Ð¾Ð·Ð¶Ðµ Ð² Ð³Ð°Ð¹Ð´Ðµ

COPY dbt/profiles.yml /opt/dbt/profiles.ymlÂ Â 

```
Â Â Â Â Â Â 

Ð–Ð¼ÐµÐ¼ ctrl+S Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ

Ð•Ñ‰Ðµ Ð½Ð°Ð´Ð¾ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» .env Ð’ Ð½ÐµÐ¼ Ð±ÑƒÐ´ÑƒÑ‚ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒÑÑ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð².

.env â€” ÑÑ‚Ð¾ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð», Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼ Ð²Ñ‹ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (environment variables) Ð´Ð»Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð².

ÐžÐ½ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð² docker-compose.yml, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿Ñ€Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð´ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð»Ð¸ Ñ‡Ð°ÑÑ‚Ð¾ Ð¼ÐµÐ½ÑÑŽÑ‰Ð¸ÐµÑÑ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð² yaml-Ñ„Ð°Ð¹Ð»Ðµ.

  

Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ð² ÑÑ‚Ð¾Ð¹ Ð¶Ðµ Ð¿Ð°Ð¿ÐºÐµ Ð¸ Ð½Ð°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ñ‹Ð¼:

ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ ÐºÐ»Ð¸ÐºÑ…Ð°ÑƒÐ·Ð° Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð±Ñ‹Ð» Ð¿ÑƒÑÑ‚Ñ‹Ð¼ Ð¸ Ð±ÐµÐ· Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð²!

  ```

# =========================

# ðŸ”— ClickHouse Connection

# =========================

  

CLICKHOUSE_HOST=host.docker.internal

CLICKHOUSE_PORT=8123

CLICKHOUSE_USERNAME=default

CLICKHOUSE_PASSWORD=

CLICKHOUSE_DATABASE=default

CLICKHOUSE_RAW_DATA_SCHEMA=default

# Ð¥Ð¾ÑÑ‚ ClickHouse (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¸Ð· Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°; host.docker.internal â€” alias Ð½Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¼Ð°ÑˆÐ¸Ð½Ñƒ)

# HTTP-Ð¿Ð¾Ñ€Ñ‚ ClickHouse (ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚: 8123)

# ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ClickHouse

# ÐŸÐ°Ñ€Ð¾Ð»ÑŒ (Ð² Ð´Ð°Ð½Ð½Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¿ÑƒÑÑ‚Ð¾Ð¹, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð»Ñ default)

# Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ

# Ð¡Ñ…ÐµÐ¼Ð° Ð´Ð»Ñ "ÑÑ‹Ñ€Ñ‹Ñ…" Ð´Ð°Ð½Ð½Ñ‹Ñ… (RAW-Ñ„Ð°Ð·Ð° ELT/ETL Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°)

# ========================

# âœˆï¸ Airflow (Docker-Compose)

# ========================

  

AIRFLOW_UID=1000Â  # UID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°, ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÑŽÑ‰Ð¸Ð¹ Ñ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ Ð½Ð° Ñ…Ð¾ÑÑ‚Ðµ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, `id -u`), Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸Â 

  

# =====================

# ðŸ›  dbt (Data Build Tool)

# =====================

  

DBT_PROFILES_DIR=/opt/dbtÂ  # ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³, Ð³Ð´Ðµ dbt Ð¸Ñ‰ÐµÑ‚ profiles.yml (Ñ„Ð°Ð¹Ð» Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº DWH).

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¿ÐµÑ€ÐµÐ¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ð´ÐµÑ„Ð¾Ð»Ñ‚ (~/.dbt/) Ð¸ Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÑ‚ Ð¿ÑƒÑ‚ÑŒ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
```
Ð”Ð°Ð»ÐµÐµ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ dbt (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð² VS code Ð²ÑÐµ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ) Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð² Ð½ÐµÐ¹ Ñ„Ð°Ð¹Ð» profiles.yml. ÐÐ°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐµÐ³Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ñ‹Ð¼:

```
poligon:

Â Â target: dev

Â Â outputs:

Â Â Â Â dev:

Â Â Â Â Â Â type: clickhouse

Â Â Â Â Â Â driver: http

Â Â Â Â Â Â host: "{{ env_var('CLICKHOUSE_HOST') }}"

Â Â Â Â Â Â port: "{{ env_var('CLICKHOUSE_PORT') | as_number }}"Â  #| as_number â€” Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÑ‚ ÑÑ‚Ñ€Ð¾ÐºÑƒ "8123" Ð² Ñ‡Ð¸ÑÐ»Ð¾ 8123

Â Â Â Â Â Â user: "{{ env_var('CLICKHOUSE_USERNAME') }}"

Â Â Â Â Â Â password: "{{ env_var('CLICKHOUSE_PASSWORD') }}"

Â Â Â Â Â Â database: "{{ env_var('CLICKHOUSE_DATABASE') }}"

Â Â Â Â Â Â schema: "{{ env_var('CLICKHOUSE_RAW_DATA_SCHEMA') }}"

Â Â Â Â Â Â secure: falseÂ  # Ð•ÑÐ»Ð¸ ClickHouse Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð½Ð° SSL, Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ true, Ð¸Ð½Ð°Ñ‡Ðµ false

  

#env_var(...) â€” Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ dbt Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¸Ð· .env
```
  ![[poligon_airflow_dbt_2.png]]

Ð’ÑÑ‘, Ñ‡Ñ‚Ð¾ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ {{ ... }}, Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¸Ð·Ð°Ñ‚Ð¾Ñ€ Jinja2 â€” ÑÑ‚Ð¾ Ñ‚Ð¾Ñ‚ Ð¶Ðµ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¸Ð·Ð°Ñ‚Ð¾Ñ€, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ SQL-Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ DBT (Ð² models/*.sql), Ð¼Ð°ÐºÑ€Ð¾ÑÐ°Ñ… Ð¸ Ñ‚.Ð´. ÐœÑ‹ ÐµÐ³Ð¾ ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¸ Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ð¾Ð¼ Ð³Ð°Ð¹Ð´Ðµ Ð¸ Ð²Ð¿ÐµÑ€Ð²Ñ‹Ðµ ÑƒÐ²Ð¸Ð´ÐµÐ»Ð¸ Ð²Ð¾Ð¾Ñ‡Ð¸ÑŽ! ÐšÑ€ÑƒÑ‚Ð°Ñ Ñ…Ñ€ÐµÐ½ÑŒ, ÑÐºÐ°Ð¶Ñƒ Ñ Ð²Ð°Ð¼!ðŸ˜Ž



Ð¢ÐµÐ¿ÐµÑ€ÑŒ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ€ÑÐ´Ð¾Ð¼ Ð¸ Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐµÐ³Ð¾ docker-compose.yml Ð´Ð»Ñ airflow. Ð­Ñ‚Ð¾ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð½Ð°ÑˆÐµÐ³Ð¾ ÐºÐ¾Ð¼Ð¿Ð¾Ð·Ð¸ÐºÐ° Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ ÑÐ¼Ð»:


Ð¯ ÑƒÐ¶Ðµ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ð» ÐµÐ³Ð¾, Ð½Ð¾ Ð¾Ð½ Ð´Ð¾Ð²Ð¾Ð»ÑŒÐ½Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹, Ð¿Ñ€Ð¸Ð»Ð¾Ð¶Ñƒ Ð¿Ð¾Ð´ Ð¿Ð¾ÑÑ‚Ð¾Ð¼, Ð±Ð°Ñ…Ð°ÐµÐ¼ ÐµÐ³Ð¾ Ð² docker_folder.
https://github.com/Byaha98/bigdata_knoweledge_base_ru/blob/main/%D0%91%D0%B0%D0%B7%D0%B0%20%D0%B7%D0%BD%D0%B0%D0%BD%D0%B8%D0%B9%20bigdata%20%D0%BD%D0%B0%20%D1%80%D1%83%D1%81%D1%81%D0%BA%D0%BE%D0%BC%20%D1%8F%D0%B7%D1%8B%D0%BA%D0%B5/%D0%A1%D1%82%D0%B0%D1%82%D1%8C%D0%B8%20%D0%BF%D0%BE%20%D0%BF%D0%BE%D0%BB%D0%B8%D0%B3%D0%BE%D0%BD%D1%83%20BigData/airflow_dbt_compose/docker-compose.yml
  
  

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²ÑÐµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð². ÐÐ°Ð¼ Ð½ÑƒÐ¶ÐµÐ½ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð´Ð¾Ð±Ñ€Ñ‹Ð¹ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð». Ð–Ð¼ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¾Ð¹ ÐºÐ½Ð¾Ð¿ÐºÐ¾Ð¹ Ð¼Ñ‹ÑˆÐ¸ Ð½Ð° Ð¿Ð°Ð¿ÐºÑƒ docker_folder Ð¸ Ð±Ð°Ñ…Ð°ÐµÐ¼ "Open in Integrated Terminal".
![[poligon_airflow_dbt_3.png]]

Ð—Ð°Ð¹Ð´ÐµÐ¼ Ð² Ð½Ð°ÑˆÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:
```
su Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½ÐµÐ¹Ð¼
```
  

ÐŸÐ¾Ñ€Ð° Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð½Ð°Ñˆ ÐºÐ¾Ð¼Ð¿Ð¾Ð·Ð¸Ðº!

ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾! ÐÐ°Ñˆ Ð¾Ð±Ñ€Ð°Ð· Airflow Ð²ÐµÑÐ¸Ñ‚ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð³Ð¸Ð³Ð°Ð±Ð°Ð¹Ñ‚, Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ Ñ Python + Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÐ¼Ð¸. ÐžÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚Ðµ Ð¼ÐµÑÑ‚Ð¾ Ð½Ð° Ð´Ð¸ÑÐºÐµ, ÐµÑÐ»Ð¸ Ð¼Ð°Ð»Ð¾.

Ð‘Ð°Ñ…Ð°ÐµÐ¼:
  
```
docker compose build
```
  

Ð–Ð´ÐµÐ¼, Ð¿Ð¾ÐºÐ° Ð²ÑÐµ Ð¿Ð¾ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑÑ. ÐœÐ¾Ð¶ÐµÑ‚ Ð·Ð°Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð¾Ñ‚ 2 Ð´Ð¾ 30+ Ð¼Ð¸Ð½ÑƒÑ‚, Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¸Ð½ÐµÑ‚Ð° Ð¸ ÐºÐ¾Ð¼Ð¿Ð¸ÐºÐ°. Ð£ Ð¼ÐµÐ½Ñ Ð¾ÐºÐ¾Ð»Ð¾ 20 Ð¼Ð¸Ð½ÑƒÑ‚ Ð·Ð°Ð½ÑÐ»Ð¾.

Ð•ÑÐ»Ð¸ Ð±ÑƒÐ´ÐµÑ‚Ðµ Ð² Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ¼ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ build Ñ Ð½ÐµÐ·Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð² Ñ„Ð°Ð¹Ð»Ð°Ñ…, Ð·Ð° ÑÑ‡ÐµÑ‚ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐ»Ð¾ÐµÐ² Docker Ð±ÑƒÐ´ÐµÑ‚ ÑÑ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð² Ñ€Ð°Ð·Ñ‹ Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ. Ð£ Ð¼ÐµÐ½Ñ ÑÑ‚Ð¾ Ð²Ð¸Ð´Ð½Ð¾ Ð½Ð° ÑÐºÑ€Ð¸Ð½Ð°Ñ…, Ñ‚.Ðº. Ñ Ð½Ðµ Ñ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð° Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ð» Ð²ÑÐµ)))

  

Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ - Ð´Ð¾Ð¶Ð´Ð°Ñ‚ÑŒÑÑ Ð·Ð°Ð²ÐµÑ‚Ð½Ñ‹Ñ… ÑÑ‚Ñ€Ð¾Ðº:

  
```
[+] Building 5/5

Â âœ”ï¸ airflow-apiserverÂ  Â  Â  BuiltÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  0.0sÂ 

Â âœ”ï¸ airflow-init Â  Â  Â  Â  Â  BuiltÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  0.0sÂ 

Â âœ”ï¸ airflow-dag-processorÂ  BuiltÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  0.0sÂ 

Â âœ”ï¸ airflow-schedulerÂ  Â  Â  BuiltÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  0.0sÂ 

Â âœ”ï¸ airflow-triggererÂ  Â  Â  BuiltÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  0.0s
```
  
![[poligon_airflow_dbt_4.png]]


ÐŸÐ¾ÑÐ»Ðµ Ñ‚Ð¾Ð³Ð¾, ÐºÐ°Ðº ÑÐ´ÐµÐ»Ð°Ð»Ð¸ build, Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° init:

  
```
docker compose up airflow-init
```

Ð–Ð´ÐµÐ¼ Ð½Ð°Ð´Ð¿Ð¸ÑÐ¸  Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ:
```

airflow-init-1 exited with code 0
```
![[poligon_airflow_dbt_5.png]]
Ð‘Ð°Ñ…Ð°ÐµÐ¼ Ð´Ð¾ÐºÐµÑ€ Ð¿Ñ
```
docker ps
```
  

Ð’Ð¸Ð´Ð¸Ð¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð´Ð½ÑÐ»ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÑ‚Ð³Ñ€ÐµÑ. ÐÐ¾ Ñ‚Ð°Ðº Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ, Ð¿Ð¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ð²ÑÐµ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ:

```
docker compose up -d
```

  
Ð¤Ð»Ð°Ð³ -d Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ docker compose up -d Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚ "detached mode" â€” Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ.

Ð‘ÑƒÐ´ÑƒÑ‚ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ‚Ð¸Ð¿Ð°:

```

[+] Running 6/6

Â âœ”ï¸ Container docker_folder-postgres-1 Â  Â  Â  Â  Â  Â  Â  HealthyÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  1.3sÂ 

Â âœ”ï¸ Container docker_folder-airflow-scheduler-1Â  Â  Â  Started Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  24.9sÂ 

Â âœ”ï¸ Container docker_folder-airflow-dag-processor-1Â  Started Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  25.0sÂ 

Â âœ”ï¸ Container docker_folder-airflow-apiserver-1Â  Â  Â  Started Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  24.8sÂ 

Â âœ”ï¸ Container docker_folder-airflow-triggerer-1Â  Â  Â  Started Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  24.8sÂ 

Â âœ”ï¸ Container docker_folder-airflow-init-1 Â  Â  Â  Â  Â  ExitedÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  24.0sÂ 
```
  

ÐœÐ¾Ð¶ÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð½Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ

  
```
docker ps
```
  
![[poligon_airflow_dbt_6.png]]
ÐšÐ°Ðº Ð·Ð°Ð¹Ñ‚Ð¸ Ð² Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð¿Ð¾Ð´Ð½ÑÑ‚Ñ‹Ð¹ airflow?


ÐœÐ¾Ð¶ÐµÐ¼ Ð²Ð±Ð¸Ñ‚ÑŒ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ


http://localhost:8080/


Ð˜Ð»Ð¸ VS code ÑÐ°Ð¼ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ Ð½Ð°Ð¼ Ð·Ð°Ð¹Ñ‚Ð¸ Ð½Ð° ÑÐ°Ð¹Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ Airflow. ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ Ð¼Ð¸Ð½ÑƒÑ‚ Ð¿ÑÑ‚ÑŒ, Ð¿ÑƒÑÑ‚ÑŒ ÑÐµÑ€Ð²Ð°Ðº Ð¿Ð¾Ð´Ð½Ð¸Ð¼ÐµÑ‚ÑÑ

  
Ð›Ð¾Ð³Ð¸Ð½ Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ Airflow ÑÑ‚Ð¾ airflow Ð¸ airflow

  

ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°Ð¼Ð¸, ÑÐ´ÐµÐ»Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ð¼Ð¿Ð¾Ð·, Ð»ÑƒÑ‡ÑˆÐµ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ð¼Ð¿Ð¾Ð·:

  
```
docker compose up -dÂ 
```
ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð°ÐµÑ‚ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð² Ñ„Ð¾Ð½Ðµ
```
docker compose restartÂ  
```
ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð²ÑÑ‘ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿Ð¾ÑÐ»Ðµ Ð¿Ñ€Ð°Ð²Ð¾Ðº)
```
docker compose stop
```
ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚, Ð½Ð¾ Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÐµÑ‚
```
docker compose start
```
Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹

```
docker compose downÂ  
```
ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÑ‚

  
Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¼Ð¾Ð¶ÐµÐ¼ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ð² Ð½Ð°Ñˆ VS Code. Ð¢Ð°Ðº ÐºÐ°Ðº Ñƒ Ð½Ð°Ñ Ð¿Ñ€Ð¾ÐºÐ¸Ð½ÑƒÑ‚ volume Ð¼ÐµÐ¶Ð´Ñƒ Ð¿Ð°Ð¿ÐºÐ¾Ð¹ dags Ñƒ Ð½Ð°Ñ Ð² docker_folder Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð¼, Ð²ÑÐµ Ð´Ð°Ð³Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ñ‹ ÑÐ´ÐµÐ»Ð°ÐµÐ¼ Ð² Ð¿Ð°Ð¿ÐºÐµ dags Ñƒ ÑÐµÐ±Ñ, Ð¿Ð¾Ð¿Ð°Ð´ÑƒÑ‚ Ñ‚ÑƒÑ‚ Ð¶Ðµ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€. Ð¡Ð¸Ð»Ð° Ñ‚Ð¾Ð¼Ð¾Ð² Docker!ðŸ˜‰

  
Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð½Ð°Ð´Ð¾ Ð·Ð°Ð¹Ñ‚Ð¸ Ð² Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° (Ð² ÑƒÑ‡ÐµÐ±Ð½Ñ‹Ñ… Ñ†ÐµÐ»ÑÑ…, Ð²ÑÐµ Ð±ÑƒÐ´ÐµÐ¼ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð² scheduler, Ð½Ð¾ Ð² Ð±Ð¾ÐµÐ²Ñ‹Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸ÑÑ… Ð»ÑƒÑ‡ÑˆÐµ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ worker-ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€)

  
Ð˜Ð´ÐµÐ¼ Ð² Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» Ð½Ð°ÑˆÐµÐ¹ docker_folder Ð¸ Ð²Ð²Ð¾Ð´Ð¸Ð¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð½Ð° Ð·Ð°Ñ…Ð¾Ð´ Ð² Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°. Ð§Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¸Ð¼Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°, Ð´ÐµÐ»Ð°ÐµÐ¼ docker ps Ð¸ ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ð¼ name Ð½ÑƒÐ¶Ð½Ð¾Ð³Ð¾ Ð½Ð°Ð¼ scheduler ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°:

  
```
docker execÂ  -it docker_folder-airflow-scheduler-1Â  /bin/bashÂ 
```

Ð£ Ð½Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ default. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ð°Ð¿ÐºÑƒ dbt Ñ‡ÐµÑ€ÐµÐ· ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:

  
```
cd .. && cd dbt
```

  

Ð’ÑÐµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº ÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÑŽ DBT Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°! Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ ÑÐ´ÐµÐ»Ð°ÐµÐ¼ ÑÑ‚Ð¾! Ð’Ð²Ð¾Ð´Ð¸Ð¼:

  
```
dbt init poligon
```

  

poligon - Ð¸Ð¼Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°, profiles dir Ð¿Ð¾Ð¼ÐµÑ‡Ð°ÐµÑ‚, Ð³Ð´Ðµ Ñƒ Ð½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ñ„Ð°Ð¹Ð»Ð° profiles. (ÐœÑ‹ ÐµÐ³Ð¾ Ð¿Ñ€Ð¾ÐºÐ¸Ð½ÑƒÐ»Ð¸ Ð² opt/dbt Ð¸Ð· docker_folder/dbt).

```
The profile poligon already exists in /opt/dbt/profiles.yml. Continue and overwrite it? [y/N]:
```
 Â  - Ð¿Ð¸ÑˆÐµÐ¼ y, Ð±Ð°Ñ…Ð°ÐµÐ¼ enter

  
Ð£ Ð½Ð°Ñ ÑÐ¿Ñ€Ð¾ÑÑÑ‚, ÐºÐ°ÐºÑƒÑŽ Ð‘Ð” ÑŽÐ·Ð°Ñ‚ÑŒ, ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ Ð¶Ð¼ÐµÐ¼ Ñ†Ð¸Ñ„Ñ€Ñƒ 1 - clickhouse!
```
Which database would you like to use?

[1] clickhouse
```
![[poligon_airflow_dbt_7.png]]
![[poligon_airflow_dbt_8.png]]
Ð‘ÑƒÐ´ÐµÑ‚ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ñ‚Ð¸Ð¿Ð° `12:00:06Â  No sample profile found for clickhouse.` Ð¢ÑƒÑ‚ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ ÑÑ‚Ñ€Ð°ÑˆÐ½Ð¾Ð³Ð¾
  
Ð’ÑÐµ! DBT Ð¿Ñ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½, Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð°Ð¶Ð¸Ð¼Ð°Ñ‚ÑŒ exit Ð¸ Ð¸Ð´Ñ‚Ð¸ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð² UI Airflow!

ÐœÐ¾Ð¶Ð½Ð¾ Ð²Ð²ÐµÑÑ‚Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ exit Ð´Ð»Ñ Ð²Ñ‹Ñ…Ð¾Ð´Ð° Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°, Ñ‚Ð°ÐºÐ¶Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ, Ñ‡Ñ‚Ð¾ DBT Ð¿Ñ€Ð¾ÐµÐºÑ‚ ÑÐ¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð»ÑÑ Ð¸ Ð½Ð° Ñ…Ð¾ÑÑ‚!



Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ñ‚Ð°ÐºÐ¶Ðµ Ð¿Ð¾Ð´Ð½Ð¸Ð¼ÐµÐ¼ Clickhouse! Ð£Ð²Ñ‹, ÐºÐ»Ð¸ÐºÑ…Ð°ÑƒÐ· Ð¸Ð· Ð¿Ñ€Ð¾ÑˆÐ»Ð¾Ð³Ð¾ Ð³Ð°Ð¹Ð´Ð° Ð¿Ñ€Ð¸Ð´ÐµÑ‚ÑŒÑÑ ÑƒÐ±Ð¸Ñ‚ÑŒ... âš°ï¸

  ```

docker rm clickhouse-server (Ð¸Ð»Ð¸ Ð²Ð°ÑˆÐµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ)
```
  

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð½Ð°Ð´Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ñ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¸Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°. ÐÐµ Ð±Ð¾Ð¹Ñ‚ÐµÑÑŒ! ÑÑ‚Ð¾ Ð½Ð¸ÐºÐ°Ðº Ð½Ðµ Ð¿Ð¾Ð²Ð»Ð¸ÑÐµÑ‚ Ð½Ð° connection Ð² Dbeaver Ð¸Ð· Ð¿Ñ€Ð¾ÑˆÐ»Ð¾Ð³Ð¾ Ð³Ð°Ð¹Ð´Ð°! Ð’ÑÐµ Ð¾ÑÑ‚Ð°Ð½ÐµÑ‚ÑÑ!ðŸ§ 

  ```

docker run -d \

Â Â --name clickhouse-server \

Â Â --network=host \

Â Â --cap-add=SYS_NICE \

Â Â --cap-add=NET_ADMIN \

Â Â --cap-add=IPC_LOCK \

Â Â -v clickhouse-data:/var/lib/clickhouse \

Â Â -v clickhouse-logs:/var/log/clickhouse-server \

Â Â clickhouse/clickhouse-server:24.3.6
```
  

Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð½Ð°Ð¿Ð¸ÑˆÐµÐ¼ DAG, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹Â  Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ Ð½Ð°ÑˆÑƒ Ð¿ÐµÑ€Ð²ÑƒÑŽ DBT Ð¼Ð¾Ð´ÐµÐ»ÑŒ! ÐžÐ½Ð° ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ!

Ð”Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð² Ð¿Ð°Ð¿ÐºÐµ dags ÑÐ¾Ð·Ð´Ð°Ð´Ð¸Ð¼ Ñ„Ð°Ð¹Ð» dbt_dag.py Ð² VS code


ÐšÐ¾Ð´ Ð´Ð»Ñ dbt_dag.py:

  ```

from airflow.decorators import dag, taskÂ  # Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹ TaskFlow APIÂ Â 

from airflow.operators.bash import BashOperatorÂ  # Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ bash-ÐºÐ¾Ð¼Ð°Ð½Ð´Â Â 

from datetime import datetimeÂ  # Ð´Ð»Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸

  

# ðŸŽ¯ ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ DAG Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð´ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð° @dag

@dag(

Â Â Â Â dag_id='dbt_run_my_first_model',Â  # ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ DAG

Â Â Â Â schedule=None,Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # Ð·Ð°Ð¿ÑƒÑÐº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ, Ð±ÐµÐ· Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ

Â Â Â Â catchup=False,Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑ‚ÑŒ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð´Ð°Ñ‚Ñ‹ Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ

)

def dbt_dag():

Â Â Â Â # ðŸ”§ ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° DBT Ñ‡ÐµÑ€ÐµÐ· Bash

Â Â Â Â run_dbt_model = BashOperator(

Â Â Â Â Â Â Â Â task_id="run_dbt_model_bash",Â  # Ð¸Ð¼Ñ Ð·Ð°Ð´Ð°Ñ‡Ð¸

Â Â Â Â Â Â Â Â bash_command="cd /opt/dbt/poligon && echo '== DBT debug ==' && dbt debug && echo '== DBT run ==' && dbt run --select my_first_dbt_model",Â  # ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ

Â Â Â Â Â Â Â Â do_xcom_push=True,Â  # ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð² XCom (Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹)

Â Â Â Â )

Â Â Â Â Â Â Â Â Â Â Â Â #cd /opt/dbt/poligonÂ  Â  Â  Â  Â  Â  Â  # Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ dbt

Â Â Â Â Â Â Â Â Â Â Â Â #echo "== DBT debug ==" Â  Â  Â  Â  # Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ

Â Â Â Â Â Â Â Â Â Â Â Â #dbt debugÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ dbt

Â Â Â Â Â Â Â Â Â Â Â Â #echo "== DBT run ==" Â  Â  Â  Â  Â  # Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ

Â Â Â Â Â Â Â Â Â Â Â Â #dbt run --select models/example/my_first_dbt_model.sql - Ð¿ÑƒÑ‚ÑŒ Ðº Ð¼Ð¾Ð´ÐµÐ»Ð¸, --select Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ

  

# âœ¨ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€Ð° DAG: Airflow Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ ÐµÐ³Ð¾ Ð¿Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ dag

dag = dbt_dag()
```
  

ÐšÐ¾Ð³Ð´Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ð¼ Ñ„Ð°Ð¹Ð» DAG, Ð½Ð°Ð´Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð°Ñ‚ÑŒ Ð¾ÐºÐ¾Ð»Ð¾ 5 Ð¼Ð¸Ð½ÑƒÑ‚, Ð¿Ñ€ÐµÐ¶Ð´Ðµ Ñ‡ÐµÐ¼ Airflow ÐµÐ³Ð¾ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ Ð¸ Ð²Ñ‹Ð²ÐµÐ´ÐµÑ‚ Ð² Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ. ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ñ‚ÑŒ, Ð½Ð¾ Ð»ÑƒÑ‡ÑˆÐµ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ñ‡Ð°ÑÑ‚Ð¾ Ð½Ðµ Ð´ÐµÐ»Ð°Ñ‚ÑŒ.

  

ðŸ§© Ð§Ñ‚Ð¾ Ð·Ð´ÐµÑÑŒ Ð¸ ÐºÐ°Ðº Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ ÑƒÑÑ‚Ñ€Ð¾ÐµÐ½ DAG

@dag-Ð´ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€

â€” Ð¿Ñ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ dbt_dag() Ð² DAG-Ð¾Ð±ÑŠÐµÐºÑ‚. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ, ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¸ÑÐ²Ð¾ÐµÐ½Ð° Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ (dag = ...)Â 

  
ÐÑ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ schedule=None, catchup=False

â€” Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐº "Ð¾Ñ‚ÑÑ‚Ð°ÑŽÑ‰Ð¸Ñ…" Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð²Â 

  
BashOperator

â€” Ð¾Ð´Ð¸Ð½ Ð¸Ð· ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²: Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ shell-ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ. Ð—Ð´ÐµÑÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ dbt debug/runÂ 


do_xcom_push=True

â€” ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð²Ñ‹Ð²Ð¾Ð´ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð² XCom, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ñ‚Ð°ÑÐºÐ°Ð¼ â€” Ñ‚Ð¸Ð¿Ð¸Ñ‡Ð½Ð°Ñ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ° Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ bash + TaskFlow. XCom - ÑÑ‚Ð¾ Ñ‚Ð°ÐºÐ°Ñ Ñ…Ñ€ÐµÐ½ÑŒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸ DAG Ð¸ ÑÑ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð°Ð¶Ðµ Ð² ÑÐ¿ÐµÑ†Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ Ð¾Ð´Ð½Ð¾Ð¸Ð¼ÐµÐ½Ð½Ð¾Ð¼ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð² UI Airflow. Ð”Ð¾Ð²Ð¾Ð»ÑŒÐ½Ð¾ ÑƒÐ´Ð¾Ð±Ð½Ð¾

  
Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸

â€” Ð² Ð´Ð°Ð½Ð½Ð¾Ð¼ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ðµ Ð¾Ð´Ð½Ð° Ð·Ð°Ð´Ð°Ñ‡Ð°, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð²ÑÑ‘ Ð¿Ñ€Ð¾ÑÑ‚Ð¾. ÐœÐ¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ >>, << Ð¸Ð»Ð¸ TaskFlow Ð²Ñ‹Ð·Ð¾Ð²Ñ‹ Ð´Ð»Ñ Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ñ DAGÂ 

  

ðŸ§  Ð¢Ð¸Ð¿Ð¸Ñ‡Ð½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° DAG Ð² Airflow

1. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ DAG â€” Ñ‡ÐµÑ€ÐµÐ· Ð´ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€ @dag(...) Ð¸Ð»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ with DAG(...).


2. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡ â€” Ñ‚Ð°ÑÐºÐ¸ Ð»Ð¸Ð±Ð¾ Ñ‡ÐµÑ€ÐµÐ· Ð´ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹ @task, Ð»Ð¸Ð±Ð¾ Ñ‡ÐµÑ€ÐµÐ· Operators (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, BashOperator, PythonOperator).


3. Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ DAG â€” Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð² Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ðµ Ð¸Ð¼ÐµÐ½, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Airflow ÐµÑ‘ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶Ð¸Ð»

  

ÐšÑÑ‚Ð°Ñ‚Ð¸! ÐœÑ‹ Ð¼Ð¾Ð¶ÐµÐ¼ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ð¸ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð´ DAGÐ¾Ð² Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² VS code! ÐœÑ‹ Ð¶Ðµ ÐµÑ‰Ðµ Ð¸ code editor Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ð»Ð¸! Ð•Ð³Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð°Ð¹Ñ‚Ð¸ Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ Plugins. ÐžÑ‚ÐºÑ€Ð¾ÐµÐ¼ ÐµÐ³Ð¾ Ð¸ ÑƒÐ²Ð¸Ð´Ð¸Ð¼Â  Ñ„Ð°Ð¹Ð» Ð½Ð°ÑˆÐµÐ³Ð¾ DAG Ñ Ñ…Ð¾ÑÑ‚Ð°!ðŸ˜Ž

![[poligon_airflow_dbt_9.png]]
Ð”Ð°Ð»ÐµÐµ Ð·Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» dags Ð¸ Ð´ÐµÐ»Ð°ÐµÐ¼ trigger Ð½Ð°ÑˆÐµÐ³Ð¾ dag! ÐÐ° unpause Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð³Ð°Ð»Ð¾Ñ‡ÐºÑƒ. Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° Ð²ÑÐµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ!
![[poligon_airflow_dbt_10.png]]
![[poligon_airflow_dbt_11.png]]

![[poligon_airflow_dbt_12.png]]
Ð—Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð² Clickhouse Ð¸ Ð²Ð¸Ð´Ð¸Ð¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ‡ÐºÑƒ Ð¾Ñ‚ Ð½Ð°ÑˆÐµÐ¹ Ð¿ÐµÑ€Ð²Ð¾Ð¹ DBT Ð¼Ð¾Ð´ÐµÐ»Ð¸!
![[poligon_airflow_dbt_13.png]]
  
ÐœÐµÐ³Ð° Ð³Ð¾Ð¾Ð¾Ð¾Ð¾Ð¾Ð¾Ð¾Ð¾Ð¾Ð¾Ð¾Ð¾Ð» Ð²ÑÐµÐ¼, ÐºÑ‚Ð¾ ÑÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑÑ!ðŸ•¸ðŸ·ðŸ»

