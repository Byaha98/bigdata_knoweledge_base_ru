В этой небольшой статье по полигону мы интегрируем clickhouse в общий docker-compose и рассмотрим ограничения ресурсов в Docker.

Прошлые статьи в рамках домашнего полигона дата инженерии и аналитики:
  

Как поставить WSL, docker и убунту в него и Dbeaver для работы с БД 

[[1 Часть Dbeaver Docker WSL Ubuntu]]

Как развернуть у себя Clickhouse локально: 

[[2 Часть Локальное поднятие Clickhouse]]

Как подготовить VS code и WSL к работе на полигоне

[[3 Часть Подготовка WSL и VS code к полигону]]

Большой гайд по развертыванию Airflow+DBT

[[4 часть Разворачиваем Airflow 3.0.3 и DBT]]

Как сделать свой репозиторий под полигон

[[5 часть Свой репозиторий github под полигон]]

Я сделал несколько нововведений в репозиторий полигона, чтобы можно было получить clickhouse-airflow-dbt сразу из коробки из коробки в докере на любой ОС.

Чтобы посмотреть изменения, можно склонировать(или сделать pull, если клонировали) изменения из репозитория https://github.com/Byaha98/bigdata_poligon/tree/main

в docker-compose был добавлен clickhouse + прокинуты тома для его файлов
![[poligon_airflow_dbt_enhanced_1.png]]
добавлен контейнер Clickhouse:


```
clickhouse-server:
  image: clickhouse/clickhouse-server:24.3.6
  container_name: clickhouse-server
  network_mode: host
  cap_add:
    - SYS_NICE
    - NET_ADMIN
    - IPC_LOCK
  volumes:
    - clickhouse-data:/var/lib/clickhouse
    - clickhouse-logs:/var/log/clickhouse-server
  restart: always

```

Прокинуты тома для файлов clickhouse:
```
volumes:
  postgres-db-volume:
  clickhouse-data:
  clickhouse-logs:

```


В Dockerfile копируется сразу весь DBT проект
![[poligon_airflow_dbt_enhanced_2.png]]
```
# Используем официальный образ Apache Airflow версии 3.0.3

FROM apache/airflow:3.0.3

#1000-Это наш пользователь с хостовой машины, который будет запускать Airflow и DBT

#Если вы не знаете свой UID, то введите в терминале команду id и посмотрите на значение UID

USER root

# Установка Python и системных зависимостей

RUN apt-get update && apt-get install -y git

  

# Задаём доступы для юзеров airflow и default (UID 1000) для /opt/dbt и /opt/airflow

RUN mkdir -p /opt/dbt /opt/airflow/logs \

&& chown -R 1000:1000 /opt/dbt /opt/airflow \

&& chown -R airflow /opt/dbt /opt/airflow

  

# Копируем шаблон profiles.yml

COPY --chown=airflow:root dbt/profiles.yml /opt/dbt/profiles.yml

  

# Копируем весь проект dbt в контейнер

COPY --chown=airflow:root dbt/poligon /opt/dbt/poligon

  

USER 1000

#установка редактора кода для Airflow DAGs

# Установка DBT и ClickHouse-зависимостей

RUN pip install --no-cache-dir \

airflow-code-editor==8.0.1 \

black isort fs-s3fs \

dbt-core==1.10.4 \

dbt-clickhouse==1.9.2 \

airflow-clickhouse-plugin==1.5.0
```
Зайдем в нашего пользователя:
```
su пользовательнейм
```

Бахаем (в новых версиях docker-compose)
  
```
docker compose build
```


После того, как сделали build, запускаем сначала init:
  
```
docker compose up airflow-init
```

Видим, что поднялся только постгрес. Но так и должно быть, поднимаем все остальные контейнеры через команду:

```
docker compose up -d
```

![[poligon_airflow_dbt_enhanced_3.png]]

Видим, что все поднялось

Можем вбить браузере

http://localhost:8080/

вводим airflow-airflow
![[poligon_airflow_dbt_enhanced_4.png]]
Прогоняем наш DAG

![[poligon_airflow_dbt_enhanced_5.png]]
Заходим в clickhouse
host - localhost
datavase/schema - default
username - default
![[poligon_clickhouse_3.png]]

DBT модель точно так же создалась, как и в прошлых частях полигона

![[poligon_airflow_dbt_enhanced_6.png]]


В Docker Compose v3.0+ (рекомендую актуальные версии) можно применять ограничения по железу для контейнеру

## Два ключевых компонента

**1. `limits` (максимальные ограничения)** — жёсткий потолок, который контейнер не может превысить:

- **CPU:** Если превышен → процесс **замедляется** (throttling)
    
- **Memory:** Если превышен → контейнер **падает** (OOM Kill)
    

**2. `reservations` (зарезервированные ресурсы)** — гарантированные ресурсы, которые система выделит:

- **CPU:** Минимум, который контейнер получит даже при конкуренции
    
- **Memory:** Система зарезервирует эти ресурсы специально для контейнера



, вот пример:
```
clickhouse-server:
  image: clickhouse/clickhouse-server:24.3.6
  container_name: clickhouse-server
  network_mode: host
  cap_add:
    - SYS_NICE
    - NET_ADMIN
    - IPC_LOCK
  volumes:
    - clickhouse-data:/var/lib/clickhouse
    - clickhouse-logs:/var/log/clickhouse-server
  restart: always
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 4G
      reservations:
        cpus: '1.0'
        memory: 2G
```
![[poligon_airflow_dbt_enhanced_7.png]]
Я не стал добавлять эти настройки в репозиторий, пусть каждый настроит себе так, как ему подходит.

Отлично! Настроили полигон для удобного и быстрого развертывания! Гооооооол