**

Тестовое задание

База данных содержит в себе четыре таблицы Clients (клиенты), Bills (счета), BillContent (строки счетов) и RetailPacks (поставки). 

Таблица Clients

|   |   |   |   |
|---|---|---|---|
||Имя поля|Тип данных|Описание|
|![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAA0ElEQVR4AcSOwQmDUBBEl0UR8WIjVmIJdiJ4EuzEEqzERryIiGKSt2ETES8iIR/HnZ2d+fv1ceOo3Di/Ca/rKuM4yjRNBjja/qGnmzENwyBlWUqe5wY4GjO/QP3mfV2WReq6lr7v3WccbZ7nj6Z+87F6sCgKASTQVL+P/TKmF6Fd11lkX+FZlpnetq0AGrRt26CG081hGEpVVYLZXK8fHC2Kolf3/izMJlqvQRBImqbSNI2gATgaM7xA4ziWIxhgSpLkM4OjMXPYZm+u1v+FnwAAAP//7j4e6QAAAAZJREFUAwCiHqfjn/2tdgAAAABJRU5ErkJggg==)|cID|Int|ID клиента|
||Name|Nvarchar(500)|Наименование|
||Inn|Nvarchar(12)|ИНН|
||Phone|Nvarchar(15)|Телефон|
||Email|Nvarchar(500)|Электронная почта|

  

Таблица Bills

|   |   |   |   |
|---|---|---|---|
||Имя поля|Тип данных|Описание|
|![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAA0ElEQVR4AcSOwQmDUBBEl0UR8WIjVmIJdiJ4EuzEEqzERryIiGKSt2ETES8iIR/HnZ2d+fv1ceOo3Di/Ca/rKuM4yjRNBjja/qGnmzENwyBlWUqe5wY4GjO/QP3mfV2WReq6lr7v3WccbZ7nj6Z+87F6sCgKASTQVL+P/TKmF6Fd11lkX+FZlpnetq0AGrRt26CG081hGEpVVYLZXK8fHC2Kolf3/izMJlqvQRBImqbSNI2gATgaM7xA4ziWIxhgSpLkM4OjMXPYZm+u1v+FnwAAAP//7j4e6QAAAAZJREFUAwCiHqfjn/2tdgAAAABJRU5ErkJggg==)|bID|Int|ID счета|
||Num|Nvarchar(50)|№ счета|
||BDate|Date|Дата выставления счета|
||PayDate|Date|Дата оплаты счета|
||cID|Int|ID клиента|

  

Таблица BillContent

|   |   |   |   |
|---|---|---|---|
||Имя поля|Тип данных|Описание|
|![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAA0ElEQVR4AcSOwQmDUBBEl0UR8WIjVmIJdiJ4EuzEEqzERryIiGKSt2ETES8iIR/HnZ2d+fv1ceOo3Di/Ca/rKuM4yjRNBjja/qGnmzENwyBlWUqe5wY4GjO/QP3mfV2WReq6lr7v3WccbZ7nj6Z+87F6sCgKASTQVL+P/TKmF6Fd11lkX+FZlpnetq0AGrRt26CG081hGEpVVYLZXK8fHC2Kolf3/izMJlqvQRBImqbSNI2gATgaM7xA4ziWIxhgSpLkM4OjMXPYZm+u1v+FnwAAAP//7j4e6QAAAAZJREFUAwCiHqfjn/2tdgAAAABJRU5ErkJggg==)|bcID|Int|ID строки счета|
||bID|Int|ID счета|
||Product|Nvarchar(50)|Название продукта|
||TariffName|Nvarchar(1000)|Название тарифа|
||ServiceName|Nvarchar(1000)|Название услуги|
||TypeID|Tinyint|1 – подключение, 2 – продление, 255 – без типа.|
||Cost|Money|Стоимость строки счета|
||Paid|Money|Оплата по строке счета|
||Cnt|Int|Количество|

  

Таблица RetailPacks

|   |   |   |   |
|---|---|---|---|
||Имя поля|Тип данных|Описание|
|![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAAA0ElEQVR4AcSOwQmDUBBEl0UR8WIjVmIJdiJ4EuzEEqzERryIiGKSt2ETES8iIR/HnZ2d+fv1ceOo3Di/Ca/rKuM4yjRNBjja/qGnmzENwyBlWUqe5wY4GjO/QP3mfV2WReq6lr7v3WccbZ7nj6Z+87F6sCgKASTQVL+P/TKmF6Fd11lkX+FZlpnetq0AGrRt26CG081hGEpVVYLZXK8fHC2Kolf3/izMJlqvQRBImqbSNI2gATgaM7xA4ziWIxhgSpLkM4OjMXPYZm+u1v+FnwAAAP//7j4e6QAAAAZJREFUAwCiHqfjn/2tdgAAAABJRU5ErkJggg==)|rpID|Int|ID поставки|
||bcID|Int|ID строки счета|
||Since|Date|Начало поставки|
||UpTo|Date|Конец поставки|

  

Схема данных:

![[DA_testovoe_kontur_1.png]]

Примечания:

- У каждого счета должна быть хотя бы одна строка счета;
    
- По каждой строке счета может быть создано любое количество поставок, а может не быть ни одной;
    
- У клиента может быть несколько параллельных поставок по одному продукту.
    
- Cost и Paid указывается за суммарное количество продуктов/услуг в строке счета, т.е. стоимость 1 шт. из строки счета = Cost/Cnt.
    

Задача

Необходимо написать скрипт, который выводит таблицу, в которой для каждого клиента указана следующая информация:

1. Наименование клиента
    
2. ИНН клиента
    
3. № счета, по которому есть открытая поставка (действующая на дату 01.01.2021) по продукту «Контур-Экстерн». Если есть несколько счетов, удовлетворяющие данному условию, необходимо вывести тот счет, по которому создана открытая поставка по «Контур-Экстерну» с максимальной датой окончания. Если нет счетов, удовлетворяющих данному условию, необходимо вывести счет с максимальной датой оплаты, в котором есть строки на «Контур-Экстерн» на подключение или продление. Не более одного счета на клиента
    
4. Дата создания счета из п.3
    
5. Дата оплаты счета из п.3
    
6. Сумма счета по всем строкам из п.3
    
7. Оплата по счету по всем строкам из п.3
    

  

Скрипт должен запускаться на MSSQL Server.

  

Тестовые данные с правильным ответом для проверки своего скрипта.

Клиенты:

![[DA_testovoe_kontur_2.png]]

Счета:

![[DA_testovoe_kontur_3.png]]

Строки счетов:

![[DA_testovoe_kontur_4.png]]

Поставки:

![[DA_testovoe_kontur_5.png]]

Ответ:

![[DA_testovoe_kontur_6.png]]

P.S.: скрипт с наполнением данных для проверки вы найдете во втором приложенном файле.

**