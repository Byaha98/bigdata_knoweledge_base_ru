<!DOCTYPE html>
<html lang="en" dir="ltr"><head><title>9 часть Особые функции Clickhouse</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;family=IBM Plex Mono:wght@400;600&amp;display=swap"/><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="Quartz 4"/><meta property="og:title" content="9 часть Особые функции Clickhouse"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="9 часть Особые функции Clickhouse"/><meta name="twitter:description" content="В прошлой части статей по полигону я сделал изолированный запуск Clickhouse 8 часть Изоляция работы с Clickhouse Теперь можно быстро одной командой докера в папке с docker compose поднять кликхауз: docker-compose up -d clickhouse-server Уникальные функции Clickhouse ч1 Посмотреть функции и ddl табли..."/><meta property="og:description" content="В прошлой части статей по полигону я сделал изолированный запуск Clickhouse 8 часть Изоляция работы с Clickhouse Теперь можно быстро одной командой докера в папке с docker compose поднять кликхауз: docker-compose up -d clickhouse-server Уникальные функции Clickhouse ч1 Посмотреть функции и ddl табли..."/><meta property="og:image:alt" content="В прошлой части статей по полигону я сделал изолированный запуск Clickhouse 8 часть Изоляция работы с Clickhouse Теперь можно быстро одной командой докера в папке с docker compose поднять кликхауз: docker-compose up -d clickhouse-server Уникальные функции Clickhouse ч1 Посмотреть функции и ddl табли..."/><meta property="twitter:domain" content="Byaha98.github.io/bigdata_knoweledge_base_ru"/><meta property="og:url" content="https://byaha98.github.io/bigdata_knoweledge_base_ru/Baza-znaniy-bigdata-na-russkom-yazyke/Stati-po-poligonu-BigData/9-chast-Osobye-funktsii-Clickhouse"/><meta property="twitter:url" content="https://byaha98.github.io/bigdata_knoweledge_base_ru/Baza-znaniy-bigdata-na-russkom-yazyke/Stati-po-poligonu-BigData/9-chast-Osobye-funktsii-Clickhouse"/><link rel="icon" href="../../../../static/icon.png"/><meta name="description" content="В прошлой части статей по полигону я сделал изолированный запуск Clickhouse 8 часть Изоляция работы с Clickhouse Теперь можно быстро одной командой докера в папке с docker compose поднять кликхауз: docker-compose up -d clickhouse-server Уникальные функции Clickhouse ч1 Посмотреть функции и ddl табли..."/><meta name="generator" content="Quartz"/><link href="../../../../index.css" rel="stylesheet" type="text/css" data-persist="true"/><style>.expand-button {
  position: absolute;
  display: flex;
  float: right;
  padding: 0.4rem;
  margin: 0.3rem;
  right: 0;
  color: var(--gray);
  border-color: var(--dark);
  background-color: var(--light);
  border: 1px solid;
  border-radius: 5px;
  opacity: 0;
  transition: 0.2s;
}
.expand-button > svg {
  fill: var(--light);
  filter: contrast(0.3);
}
.expand-button:hover {
  cursor: pointer;
  border-color: var(--secondary);
}
.expand-button:focus {
  outline: 0;
}

pre:hover > .expand-button {
  opacity: 1;
  transition: 0.2s;
}

#mermaid-container {
  position: fixed;
  contain: layout;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  display: none;
  backdrop-filter: blur(4px);
  background: rgba(0, 0, 0, 0.5);
}
#mermaid-container.active {
  display: inline-block;
}
#mermaid-container > #mermaid-space {
  border: 1px solid var(--lightgray);
  background-color: var(--light);
  border-radius: 5px;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  height: 80vh;
  width: 80vw;
  overflow: hidden;
}
#mermaid-container > #mermaid-space > .mermaid-content {
  position: relative;
  transform-origin: 0 0;
  transition: transform 0.1s ease;
  overflow: visible;
  min-height: 200px;
  min-width: 200px;
}
#mermaid-container > #mermaid-space > .mermaid-content pre {
  margin: 0;
  border: none;
}
#mermaid-container > #mermaid-space > .mermaid-content svg {
  max-width: none;
  height: auto;
}
#mermaid-container > #mermaid-space > .mermaid-controls {
  position: absolute;
  bottom: 20px;
  right: 20px;
  display: flex;
  gap: 8px;
  padding: 8px;
  background: var(--light);
  border: 1px solid var(--lightgray);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 2;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  padding: 0;
  border: 1px solid var(--lightgray);
  background: var(--light);
  color: var(--dark);
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  font-family: var(--bodyFont);
  transition: all 0.2s ease;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:hover {
  background: var(--lightgray);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:active {
  transform: translateY(1px);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:nth-child(2) {
  width: auto;
  padding: 0 12px;
  font-size: 14px;
}
/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VSb290IjoiL1VzZXJzL2tvbnN0YW50aW4vRG9jdW1lbnRzL2JhemFfem5hbml5L2JpZ2RhdGFfa25vd2VsZWRnZV9iYXNlX3J1L3F1YXJ0ei9jb21wb25lbnRzL3N0eWxlcyIsInNvdXJjZXMiOlsibWVybWFpZC5pbmxpbmUuc2NzcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtFQUNFO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBOztBQUVBO0VBQ0U7RUFDQTs7QUFHRjtFQUNFO0VBQ0E7O0FBR0Y7RUFDRTs7O0FBS0Y7RUFDRTtFQUNBOzs7QUFJSjtFQUNFO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTs7QUFHRjtFQUNFO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBOztBQUVBO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBOztBQUVBO0VBQ0U7RUFDQTs7QUFHRjtFQUNFO0VBQ0E7O0FBSUo7RUFDRTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBOztBQUVBO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFOztBQUdGO0VBQ0U7O0FBSUY7RUFDRTtFQUNBO0VBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyIuZXhwYW5kLWJ1dHRvbiB7XG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgZGlzcGxheTogZmxleDtcbiAgZmxvYXQ6IHJpZ2h0O1xuICBwYWRkaW5nOiAwLjRyZW07XG4gIG1hcmdpbjogMC4zcmVtO1xuICByaWdodDogMDsgLy8gTk9URTogcmlnaHQgd2lsbCBiZSBzZXQgaW4gbWVybWFpZC5pbmxpbmUudHNcbiAgY29sb3I6IHZhcigtLWdyYXkpO1xuICBib3JkZXItY29sb3I6IHZhcigtLWRhcmspO1xuICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1saWdodCk7XG4gIGJvcmRlcjogMXB4IHNvbGlkO1xuICBib3JkZXItcmFkaXVzOiA1cHg7XG4gIG9wYWNpdHk6IDA7XG4gIHRyYW5zaXRpb246IDAuMnM7XG5cbiAgJiA+IHN2ZyB7XG4gICAgZmlsbDogdmFyKC0tbGlnaHQpO1xuICAgIGZpbHRlcjogY29udHJhc3QoMC4zKTtcbiAgfVxuXG4gICY6aG92ZXIge1xuICAgIGN1cnNvcjogcG9pbnRlcjtcbiAgICBib3JkZXItY29sb3I6IHZhcigtLXNlY29uZGFyeSk7XG4gIH1cblxuICAmOmZvY3VzIHtcbiAgICBvdXRsaW5lOiAwO1xuICB9XG59XG5cbnByZSB7XG4gICY6aG92ZXIgPiAuZXhwYW5kLWJ1dHRvbiB7XG4gICAgb3BhY2l0eTogMTtcbiAgICB0cmFuc2l0aW9uOiAwLjJzO1xuICB9XG59XG5cbiNtZXJtYWlkLWNvbnRhaW5lciB7XG4gIHBvc2l0aW9uOiBmaXhlZDtcbiAgY29udGFpbjogbGF5b3V0O1xuICB6LWluZGV4OiA5OTk7XG4gIGxlZnQ6IDA7XG4gIHRvcDogMDtcbiAgd2lkdGg6IDEwMHZ3O1xuICBoZWlnaHQ6IDEwMHZoO1xuICBvdmVyZmxvdzogaGlkZGVuO1xuICBkaXNwbGF5OiBub25lO1xuICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoNHB4KTtcbiAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjUpO1xuXG4gICYuYWN0aXZlIHtcbiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7XG4gIH1cblxuICAmID4gI21lcm1haWQtc3BhY2Uge1xuICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWxpZ2h0Z3JheSk7XG4gICAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbGlnaHQpO1xuICAgIGJvcmRlci1yYWRpdXM6IDVweDtcbiAgICBwb3NpdGlvbjogZml4ZWQ7XG4gICAgdG9wOiA1MCU7XG4gICAgbGVmdDogNTAlO1xuICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpO1xuICAgIGhlaWdodDogODB2aDtcbiAgICB3aWR0aDogODB2dztcbiAgICBvdmVyZmxvdzogaGlkZGVuO1xuXG4gICAgJiA+IC5tZXJtYWlkLWNvbnRlbnQge1xuICAgICAgcG9zaXRpb246IHJlbGF0aXZlO1xuICAgICAgdHJhbnNmb3JtLW9yaWdpbjogMCAwO1xuICAgICAgdHJhbnNpdGlvbjogdHJhbnNmb3JtIDAuMXMgZWFzZTtcbiAgICAgIG92ZXJmbG93OiB2aXNpYmxlO1xuICAgICAgbWluLWhlaWdodDogMjAwcHg7XG4gICAgICBtaW4td2lkdGg6IDIwMHB4O1xuXG4gICAgICBwcmUge1xuICAgICAgICBtYXJnaW46IDA7XG4gICAgICAgIGJvcmRlcjogbm9uZTtcbiAgICAgIH1cblxuICAgICAgc3ZnIHtcbiAgICAgICAgbWF4LXdpZHRoOiBub25lO1xuICAgICAgICBoZWlnaHQ6IGF1dG87XG4gICAgICB9XG4gICAgfVxuXG4gICAgJiA+IC5tZXJtYWlkLWNvbnRyb2xzIHtcbiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgICAgIGJvdHRvbTogMjBweDtcbiAgICAgIHJpZ2h0OiAyMHB4O1xuICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgIGdhcDogOHB4O1xuICAgICAgcGFkZGluZzogOHB4O1xuICAgICAgYmFja2dyb3VuZDogdmFyKC0tbGlnaHQpO1xuICAgICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tbGlnaHRncmF5KTtcbiAgICAgIGJvcmRlci1yYWRpdXM6IDZweDtcbiAgICAgIGJveC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsIDAsIDAsIDAuMSk7XG4gICAgICB6LWluZGV4OiAyO1xuXG4gICAgICAubWVybWFpZC1jb250cm9sLWJ1dHRvbiB7XG4gICAgICAgIGRpc3BsYXk6IGZsZXg7XG4gICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7XG4gICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyO1xuICAgICAgICB3aWR0aDogMzJweDtcbiAgICAgICAgaGVpZ2h0OiAzMnB4O1xuICAgICAgICBwYWRkaW5nOiAwO1xuICAgICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1saWdodGdyYXkpO1xuICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1saWdodCk7XG4gICAgICAgIGNvbG9yOiB2YXIoLS1kYXJrKTtcbiAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4O1xuICAgICAgICBjdXJzb3I6IHBvaW50ZXI7XG4gICAgICAgIGZvbnQtc2l6ZTogMTZweDtcbiAgICAgICAgZm9udC1mYW1pbHk6IHZhcigtLWJvZHlGb250KTtcbiAgICAgICAgdHJhbnNpdGlvbjogYWxsIDAuMnMgZWFzZTtcblxuICAgICAgICAmOmhvdmVyIHtcbiAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1saWdodGdyYXkpO1xuICAgICAgICB9XG5cbiAgICAgICAgJjphY3RpdmUge1xuICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxcHgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3R5bGUgdGhlIHJlc2V0IGJ1dHRvbiBkaWZmZXJlbnRseVxuICAgICAgICAmOm50aC1jaGlsZCgyKSB7XG4gICAgICAgICAgd2lkdGg6IGF1dG87XG4gICAgICAgICAgcGFkZGluZzogMCAxMnB4O1xuICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19 */</style><link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" data-persist="true"/><script src="../../../../prescript.js" type="application/javascript" data-persist="true"></script><script type="application/javascript" data-persist="true">const fetchData = fetch("../../../../static/contentIndex.json").then(data => data.json())</script><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://Byaha98.github.io/bigdata_knoweledge_base_ru/index.xml"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:image" content="https://Byaha98.github.io/bigdata_knoweledge_base_ru/Baza-znaniy-bigdata-na-russkom-yazyke/Stati-po-poligonu-BigData/9-chast-Osobye-funktsii-Clickhouse-og-image.webp"/><meta property="og:image:url" content="https://Byaha98.github.io/bigdata_knoweledge_base_ru/Baza-znaniy-bigdata-na-russkom-yazyke/Stati-po-poligonu-BigData/9-chast-Osobye-funktsii-Clickhouse-og-image.webp"/><meta name="twitter:image" content="https://Byaha98.github.io/bigdata_knoweledge_base_ru/Baza-znaniy-bigdata-na-russkom-yazyke/Stati-po-poligonu-BigData/9-chast-Osobye-funktsii-Clickhouse-og-image.webp"/><meta property="og:image:type" content="image/.webp"/></head><body data-slug="Baza-znaniy-bigdata-na-russkom-yazyke/Stati-po-poligonu-BigData/9-chast-Osobye-funktsii-Clickhouse" data-base-path="/bigdata_knoweledge_base_ru"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href="/bigdata_knoweledge_base_ru/">Quartz 4</a></h2><div class="spacer mobile-only"></div><div class="flex-component" style="flex-direction: row; flex-wrap: nowrap; gap: 1rem;"><div style="flex-grow: 1; flex-shrink: 1; flex-basis: auto; order: 0; align-self: center; justify-self: center;"><div class="search"><button class="search-button"><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg><p>Search</p></button><div class="search-container"><div class="search-space"><input autocomplete="off" class="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div class="search-layout" data-preview="true"></div></div></div></div></div><div style="flex-grow: 0; flex-shrink: 1; flex-basis: auto; order: 0; align-self: center; justify-self: center;"><button class="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button></div><div style="flex-grow: 0; flex-shrink: 1; flex-basis: auto; order: 0; align-self: center; justify-self: center;"><button class="readermode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="readerIcon" fill="currentColor" stroke="currentColor" stroke-width="0.2" stroke-linecap="round" stroke-linejoin="round" width="64px" height="64px" viewBox="0 0 24 24" aria-label="Reader mode"><title>Reader mode</title><g transform="translate(-1.8, -1.8) scale(1.15, 1.2)"><path d="M8.9891247,2.5 C10.1384702,2.5 11.2209868,2.96705384 12.0049645,3.76669482 C12.7883914,2.96705384 13.8709081,2.5 15.0202536,2.5 L18.7549359,2.5 C19.1691495,2.5 19.5049359,2.83578644 19.5049359,3.25 L19.5046891,4.004 L21.2546891,4.00457396 C21.6343849,4.00457396 21.9481801,4.28672784 21.9978425,4.6528034 L22.0046891,4.75457396 L22.0046891,20.25 C22.0046891,20.6296958 21.7225353,20.943491 21.3564597,20.9931534 L21.2546891,21 L2.75468914,21 C2.37499337,21 2.06119817,20.7178461 2.01153575,20.3517706 L2.00468914,20.25 L2.00468914,4.75457396 C2.00468914,4.37487819 2.28684302,4.061083 2.65291858,4.01142057 L2.75468914,4.00457396 L4.50368914,4.004 L4.50444233,3.25 C4.50444233,2.87030423 4.78659621,2.55650904 5.15267177,2.50684662 L5.25444233,2.5 L8.9891247,2.5 Z M4.50368914,5.504 L3.50468914,5.504 L3.50468914,19.5 L10.9478955,19.4998273 C10.4513189,18.9207296 9.73864328,18.5588115 8.96709342,18.5065584 L8.77307039,18.5 L5.25444233,18.5 C4.87474657,18.5 4.56095137,18.2178461 4.51128895,17.8517706 L4.50444233,17.75 L4.50368914,5.504 Z M19.5049359,17.75 C19.5049359,18.1642136 19.1691495,18.5 18.7549359,18.5 L15.2363079,18.5 C14.3910149,18.5 13.5994408,18.8724714 13.0614828,19.4998273 L20.5046891,19.5 L20.5046891,5.504 L19.5046891,5.504 L19.5049359,17.75 Z M18.0059359,3.999 L15.0202536,4 L14.8259077,4.00692283 C13.9889509,4.06666544 13.2254227,4.50975805 12.7549359,5.212 L12.7549359,17.777 L12.7782651,17.7601316 C13.4923805,17.2719483 14.3447024,17 15.2363079,17 L18.0059359,16.999 L18.0056891,4.798 L18.0033792,4.75457396 L18.0056891,4.71 L18.0059359,3.999 Z M8.9891247,4 L6.00368914,3.999 L6.00599909,4.75457396 L6.00599909,4.75457396 L6.00368914,4.783 L6.00368914,16.999 L8.77307039,17 C9.57551536,17 10.3461406,17.2202781 11.0128313,17.6202194 L11.2536891,17.776 L11.2536891,5.211 C10.8200889,4.56369974 10.1361548,4.13636104 9.37521067,4.02745763 L9.18347055,4.00692283 L8.9891247,4 Z"></path></g></svg></button></div></div><div class="explorer" data-behavior="link" data-collapsed="collapsed" data-savestate="true" data-data-fns="{&quot;order&quot;:[&quot;filter&quot;,&quot;map&quot;,&quot;sort&quot;],&quot;sortFn&quot;:&quot;(a,b)=>!a.isFolder&amp;&amp;!b.isFolder||a.isFolder&amp;&amp;b.isFolder?a.displayName.localeCompare(b.displayName,void 0,{numeric:!0,sensitivity:\&quot;base\&quot;}):!a.isFolder&amp;&amp;b.isFolder?1:-1&quot;,&quot;filterFn&quot;:&quot;node=>node.slugSegment!==\&quot;tags\&quot;&quot;,&quot;mapFn&quot;:&quot;node=>node&quot;}"><button type="button" class="explorer-toggle mobile-explorer hide-until-loaded" data-mobile="true" aria-controls="explorer-88"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-menu"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg></button><button type="button" class="title-button explorer-toggle desktop-explorer" data-mobile="false" aria-expanded="true"><h2>Explorer</h2><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="explorer-88" class="explorer-content" aria-expanded="false" role="group"><ul class="explorer-ul overflow" id="list-0"><li class="overflow-end"></li></ul></div><template id="template-file"><li><a href="#"></a></li></template><template id="template-folder"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div><button class="folder-button"><span class="folder-title"></span></button></div></div><div class="folder-outer"><ul class="content"></ul></div></li></template></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="/bigdata_knoweledge_base_ru/">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="/bigdata_knoweledge_base_ru/Baza-znaniy-bigdata-na-russkom-yazyke/">База знаний bigdata на русском языке</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="/bigdata_knoweledge_base_ru/Baza-znaniy-bigdata-na-russkom-yazyke/Stati-po-poligonu-BigData/">Статьи по полигону BigData</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>9 часть Особые функции Clickhouse</a></div></nav><h1 class="article-title">9 часть Особые функции Clickhouse</h1><p show-comma="true" class="content-meta"><time datetime="2026-01-31T07:45:53.000Z">Jan 31, 2026</time><span>13 min read</span></p></div></div><article class="popover-hint"><p>В прошлой части статей по полигону я сделал изолированный запуск Clickhouse</p>
<p><a href="/bigdata_knoweledge_base_ru/Baza-znaniy-bigdata-na-russkom-yazyke/Stati-po-poligonu-BigData/8-chast-Izolyatsiya-raboty-s-Clickhouse/" class="internal alias" data-slug="Baza-znaniy-bigdata-na-russkom-yazyke/Stati-po-poligonu-BigData/8-chast-Izolyatsiya-raboty-s-Clickhouse/index">8 часть Изоляция работы с Clickhouse</a></p>
<p>Теперь можно быстро одной командой докера в папке с docker compose поднять кликхауз:</p>
<pre><code>docker-compose up -d clickhouse-server
</code></pre>
<p>Уникальные функции Clickhouse ч1</p>
<p>Посмотреть функции и ddl таблиц можно по ссылке:
<a href="https://github.com/Byaha98/bigdata_poligon" class="external">https://github.com/Byaha98/bigdata_poligon<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></p>
<p>Идем в Clickhouse, чтобы создавать тестовые таблицы и скрипты к ним!</p>
<p>Все DDL и SELECT из статьи я размещу в папке <span class="text-highlight">clickhouse_sql</span> внутри полигона.</p>
<p>Сначала хотел бы показать на простых примерах работу с JSON в Clickhouse. Мы можем парсить JSON с сырого слоя в DWH, если у нас в компании немного данных и юзеров. Тогда одного инстанса кликхауз хватит за глаза. Либо при скоростных пайплайнах, когда нужно быстро посчитать агрегаты и расчеты под дашборды из сервисов (например, приложения по продуктовой/маркетинговой аналитике)</p>
<p>json_table_ddl - создаем нашу табличку под жисон функции. Cаму таблицу я поместил в новую папку в основании полигона. DDL скрипт называется <span class="text-highlight">json_table_ddl</span>. Чтобы быть поближе к аналитике, представим, как будто у нас приходят данные по веб/продуктовой/маркетинговой аналитике (типа как в приложении Amplitude) в виде жисонов.</p>
<p>Итак, вот собственно и сам скрипт создания и накопления таблицы:</p>
<pre><code>-- Таблица с JSON-логами веб-события (типа как в Amplitude)

CREATE TABLE web_analytics (

event_id UInt64,

timestamp DateTime,

user_id UInt32,

session_data String, -- JSON с данными о сессии

event_properties String, -- JSON с параметрами события

user_profile String -- JSON с профилем пользователя

) ENGINE = MergeTree()

ORDER BY (timestamp);

  

-- Вставляем тестовые JSON-данные

INSERT INTO web_analytics FORMAT Values

(

1,

'2025-01-04 10:00:00',

101,

'{&quot;session_id&quot;:&quot;s_001&quot;,&quot;source&quot;:&quot;organic&quot;,&quot;campaign&quot;:&quot;&quot;,&quot;device&quot;:&quot;desktop&quot;,&quot;os&quot;:&quot;Windows&quot;,&quot;browser&quot;:&quot;Chrome&quot;}',

'{&quot;event_name&quot;:&quot;page_view&quot;,&quot;page&quot;:&quot;/products&quot;,&quot;category&quot;:&quot;electronics&quot;,&quot;load_time_ms&quot;:245,&quot;user_action&quot;:&quot;scroll&quot;}',

'{&quot;name&quot;:&quot;Alice&quot;,&quot;country&quot;:&quot;US&quot;,&quot;age&quot;:28,&quot;premium&quot;:true,&quot;ltv&quot;:1250.50,&quot;tags&quot;:[&quot;vip&quot;,&quot;high_value&quot;,&quot;loyal&quot;]}'

),

(

2,

'2025-01-04 10:05:00',

101,

'{&quot;session_id&quot;:&quot;s_001&quot;,&quot;source&quot;:&quot;organic&quot;,&quot;campaign&quot;:&quot;&quot;,&quot;device&quot;:&quot;desktop&quot;,&quot;os&quot;:&quot;Windows&quot;,&quot;browser&quot;:&quot;Chrome&quot;}',

'{&quot;event_name&quot;:&quot;product_click&quot;,&quot;product_id&quot;:&quot;SKU_789&quot;,&quot;price&quot;:899.99,&quot;currency&quot;:&quot;USD&quot;,&quot;position_on_page&quot;:3,&quot;click_time_ms&quot;:145}',

'{&quot;name&quot;:&quot;Alice&quot;,&quot;country&quot;:&quot;US&quot;,&quot;age&quot;:28,&quot;premium&quot;:true,&quot;ltv&quot;:1250.50,&quot;tags&quot;:[&quot;vip&quot;,&quot;high_value&quot;,&quot;loyal&quot;]}'

),

(

3,

'2025-01-04 10:10:00',

101,

'{&quot;session_id&quot;:&quot;s_001&quot;,&quot;source&quot;:&quot;organic&quot;,&quot;campaign&quot;:&quot;&quot;,&quot;device&quot;:&quot;desktop&quot;,&quot;os&quot;:&quot;Windows&quot;,&quot;browser&quot;:&quot;Chrome&quot;}',

'{&quot;event_name&quot;:&quot;add_to_cart&quot;,&quot;product_id&quot;:&quot;SKU_789&quot;,&quot;quantity&quot;:1,&quot;price&quot;:899.99,&quot;discount&quot;:null,&quot;estimated_shipping&quot;:19.99}',

'{&quot;name&quot;:&quot;Alice&quot;,&quot;country&quot;:&quot;US&quot;,&quot;age&quot;:28,&quot;premium&quot;:true,&quot;ltv&quot;:1250.50,&quot;tags&quot;:[&quot;vip&quot;,&quot;high_value&quot;,&quot;loyal&quot;]}'

),

(

4,

'2025-01-04 10:15:00',

101,

'{&quot;session_id&quot;:&quot;s_001&quot;,&quot;source&quot;:&quot;organic&quot;,&quot;campaign&quot;:&quot;&quot;,&quot;device&quot;:&quot;desktop&quot;,&quot;os&quot;:&quot;Windows&quot;,&quot;browser&quot;:&quot;Chrome&quot;}',

'{&quot;event_name&quot;:&quot;checkout&quot;,&quot;cart_value&quot;:899.99,&quot;items_count&quot;:1,&quot;coupon_code&quot;:&quot;SAVE20&quot;,&quot;discount_amount&quot;:180.00,&quot;final_price&quot;:719.99,&quot;payment_method&quot;:&quot;credit_card&quot;}',

'{&quot;name&quot;:&quot;Alice&quot;,&quot;country&quot;:&quot;US&quot;,&quot;age&quot;:28,&quot;premium&quot;:true,&quot;ltv&quot;:1250.50,&quot;tags&quot;:[&quot;vip&quot;,&quot;high_value&quot;,&quot;loyal&quot;]}'

),

(

5,

'2025-01-04 10:20:00',

102,

'{&quot;session_id&quot;:&quot;s_002&quot;,&quot;source&quot;:&quot;paid_search&quot;,&quot;campaign&quot;:&quot;winter_sale&quot;,&quot;device&quot;:&quot;mobile&quot;,&quot;os&quot;:&quot;iOS&quot;,&quot;browser&quot;:&quot;Safari&quot;}',

'{&quot;event_name&quot;:&quot;page_view&quot;,&quot;page&quot;:&quot;/sale&quot;,&quot;category&quot;:&quot;clothing&quot;,&quot;load_time_ms&quot;:512,&quot;user_action&quot;:&quot;view&quot;}',

'{&quot;name&quot;:&quot;Bob&quot;,&quot;country&quot;:&quot;UK&quot;,&quot;age&quot;:35,&quot;premium&quot;:false,&quot;ltv&quot;:245.30,&quot;tags&quot;:[&quot;new_user&quot;,&quot;price_sensitive&quot;]}'

),

(

6,

'2025-01-04 10:25:00',

102,

'{&quot;session_id&quot;:&quot;s_002&quot;,&quot;source&quot;:&quot;paid_search&quot;,&quot;campaign&quot;:&quot;winter_sale&quot;,&quot;device&quot;:&quot;mobile&quot;,&quot;os&quot;:&quot;iOS&quot;,&quot;browser&quot;:&quot;Safari&quot;}',

'{&quot;event_name&quot;:&quot;product_view&quot;,&quot;product_id&quot;:&quot;SKU_456&quot;,&quot;price&quot;:49.99,&quot;category&quot;:&quot;clothing&quot;,&quot;reviews_count&quot;:234,&quot;rating&quot;:4.5}',

'{&quot;name&quot;:&quot;Bob&quot;,&quot;country&quot;:&quot;UK&quot;,&quot;age&quot;:35,&quot;premium&quot;:false,&quot;ltv&quot;:245.30,&quot;tags&quot;:[&quot;new_user&quot;,&quot;price_sensitive&quot;]}'

),

(

7,

'2025-01-04 10:30:00',

102,

'{&quot;session_id&quot;:&quot;s_002&quot;,&quot;source&quot;:&quot;paid_search&quot;,&quot;campaign&quot;:&quot;winter_sale&quot;,&quot;device&quot;:&quot;mobile&quot;,&quot;os&quot;:&quot;iOS&quot;,&quot;browser&quot;:&quot;Safari&quot;}',

'{&quot;event_name&quot;:&quot;page_view&quot;,&quot;page&quot;:&quot;/checkout&quot;,&quot;load_time_ms&quot;:450,&quot;steps_completed&quot;:1,&quot;total_steps&quot;:3,&quot;error&quot;:null}',

'{&quot;name&quot;:&quot;Bob&quot;,&quot;country&quot;:&quot;UK&quot;,&quot;age&quot;:35,&quot;premium&quot;:false,&quot;ltv&quot;:245.30,&quot;tags&quot;:[&quot;new_user&quot;,&quot;price_sensitive&quot;]}'

),

(

8,

'2025-01-04 10:35:00',

103,

'{&quot;session_id&quot;:&quot;s_003&quot;,&quot;source&quot;:&quot;direct&quot;,&quot;campaign&quot;:&quot;&quot;,&quot;device&quot;:&quot;desktop&quot;,&quot;os&quot;:&quot;Mac&quot;,&quot;browser&quot;:&quot;Firefox&quot;}',

'{&quot;event_name&quot;:&quot;search&quot;,&quot;query&quot;:&quot;winter jackets&quot;,&quot;results_count&quot;:42,&quot;filters&quot;:{&quot;color&quot;:&quot;black&quot;,&quot;size&quot;:&quot;M&quot;},&quot;sort_by&quot;:&quot;price_asc&quot;}',

'{&quot;name&quot;:&quot;Carol&quot;,&quot;country&quot;:&quot;CA&quot;,&quot;age&quot;:42,&quot;premium&quot;:true,&quot;ltv&quot;:3500.75,&quot;tags&quot;:[&quot;vip&quot;,&quot;long_term&quot;,&quot;high_engagement&quot;]}'

);
</code></pre>
<p>В DDL поля JSON помечены как <code>String</code>. Он просто хранит текст JSON как есть; парсинг делается уже в запросах функциями <code>JSONExtract*</code>, <code>JSON_VALUE</code>, <code>JSON_QUERY</code> и т.п.</p>
<p>Такой подход:</p>
<ul>
<li>
<p>беспроблемно принимает любой JSON, даже с «плавающей» схемой;</p>
</li>
<li>
<p>даёт возможность позже выделить нужные поля в отдельные столбцы</p>
</li>
</ul>
<p>Сделаю еще маленькую ремарку по DDL таблицы. В Clickhouse один из самых популярных движков таблиц - это MergeTree и он требует <code>ORDER BY</code> . Он задаёт и сортировку, и первичный ключ (если не указан первичный ключ).</p>
<p>При небольшом количестве данных можно сильно не запариваться над индексом. Теория ниже тоже скорее вам пригодится в боевых условиях с большими данными, либо на собесах;)</p>
<h2 id="что-делает-mergetree">Что делает MergeTree<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#что-делает-mergetree" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li>
<p>Данные пишутся батчами: каждый <code>INSERT</code> создаёт отдельные parts (части таблицы) на диске. Поэтому лучше в реальных боевых условиях запихивать данные пачками, а не точечно (если данных много). Буквально цитируя документацию клика:</p>
<pre><code>Рекомендуем вставлять данные пакетами как минимум по 1 000 строк, а в идеале — от 10 000 до 100 000 строк. Более редкие, но более крупные вставки снижают количество записываемых кусков (parts), минимизируют нагрузку на слияния и уменьшают общее потребление ресурсов системы.
</code></pre>
</li>
<li>
<p>Внутри каждой части строки <strong>отсортированы по ключу из <code>ORDER BY</code></strong>, а для этого ключа строится разреженный первичный индекс(индекс, который хранит <strong>не каждую</strong> строку, а «маячки» на группы строк (блоки/гранулы)) по гранулам (обычно блоки по несколько тысяч строк).</p>
</li>
<li>
<p>Фоновые подкапотные потоки кликхауза периодически <strong>мерджат</strong> части: объединяют и пересортировывают их, сохраняя общий порядок по ключу сортировки.</p>
</li>
</ul>
<h2 id="зачем-нужен-order-by">Зачем нужен ORDER BY<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#зачем-нужен-order-by" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li>
<p><code>ORDER BY (timestamp, user_id)</code> задаёт <strong>ключ сортировки</strong>: все данные в каждой части будут физически лежать в этом порядке.</p>
</li>
<li>
<p>На основе этого ключа строится <strong>первичный индекс</strong> (если явно не указан <code>PRIMARY KEY</code> — он совпадает с <code>ORDER BY</code>).</p>
</li>
<li>
<p>При запросах с фильтрами по <code>timestamp</code> и/или <code>user_id</code> движок может по индексу быстро найти нужные гранулы и <strong>пропустить чтение огромных кусков данных</strong>, вместо скана всей таблицы.</p>
</li>
</ul>
<p>Итак мы сделали жисон таблицу и теперь можем поковырять наши JSON!</p>
<h2 id="jsonextractstring-простое-извлечение-строк"><strong>JSONExtractString</strong> — Простое извлечение строк<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#jsonextractstring-простое-извлечение-строк" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Проверенные временем функции по извлечению данных из JSON:</p>
<pre><code>-- Извлекаем основные параметры из JSON

SELECT

event_id,

timestamp,

user_id,

JSONExtractString(event_properties, 'event_name') AS event_name,

JSONExtractString(event_properties, 'product_id') AS product_id,

JSONExtractString(user_profile, 'country') AS user_country,

JSONExtractString(session_data, 'source') AS traffic_source

FROM web_analytics

ORDER BY event_id;
</code></pre>
<p><img src="../../../../attachments/poligon_clickhouse_functions_1.png" width="auto" height="auto" alt/></p>
<p>Мы смогли распарсить информацию из JSON и посмотреть информацию по событиям юзеров, источникам их прихода, продуктам, географии.</p>
<p>SKU - это <strong>уникальный код товарной позиции</strong> (Stock Keeping Unit), по сути «артикул» конкретного варианта товара: сочетание модели, цвета, размера, упаковки и т.п</p>
<h2 id="jsonextract-с-типизацией-извлечение-разных-типов-данных"><strong>JSONExtract с типизацией</strong> — Извлечение разных типов данных<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#jsonextract-с-типизацией-извлечение-разных-типов-данных" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<pre><code>-- Извлекаем разные типы: String, Int, Float, UInt8 (для Boolean)
SELECT
    event_id,
    JSONExtractString(event_properties, 'event_name') AS event_name,
    JSONExtract(event_properties, 'price', 'Float64') AS product_price,
    JSONExtract(event_properties, 'quantity', 'UInt32') AS quantity,
    JSONExtract(event_properties, 'discount_amount', 'Nullable(Float64)') AS discount,
    JSONExtract(user_profile, 'age', 'UInt32') AS user_age,
    JSONExtract(user_profile, 'premium', 'UInt8') AS is_premium  -- 1 = true, 0 = false
FROM web_analytics
WHERE JSONExtractString(event_properties, 'event_name') IN ('add_to_cart', 'checkout');
</code></pre>
<p><img src="../../../../attachments/poligon_clickhouse_functions_2.png" width="auto" height="auto" alt/></p>
<p>В связке с фильтром по <code>event_name</code> запрос фактически формирует выборку «покупательских» событий: кто оформлял заказы, что, по какой цене и с какой скидкой, и был ли пользователь премиальным.</p>
<p>Для продуктовой аналитики событие <code>checkout</code> обычно означает:</p>
<ul>
<li>
<p>Пользователь перешёл из корзины к оформлению заказа (начало воронки оплаты);</p>
</li>
<li>
<p>По нему считают конверсию из «добавил в корзину» в «начал оформлять» и анализируют дроп‑офф (где люди уходят).</p>
</li>
</ul>
<p>Что касается работы с JSON, то тут мы уже конкретно парсим и приводим к нужным типам данных наши новые колонки, полученные из прибывших JSON.</p>
<h2 id="jsonextractkeysandvaluesraw-парсинг-всех-ключ-значений"><strong>JSONExtractKeysAndValuesRaw</strong> — Парсинг всех ключ-значений<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#jsonextractkeysandvaluesraw-парсинг-всех-ключ-значений" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Извлекаем все ключ-значения из профиля пользователя в формате кортежей:</p>
<pre><code>SELECT
    event_id,
    user_id,
    JSONExtractKeysAndValuesRaw(user_profile) AS all_user_attributes
FROM web_analytics
LIMIT 3;
</code></pre>
<p><img src="../../../../attachments/poligon_clickhouse_functions_3.png" width="auto" height="auto" alt/></p>
<h2 id="вложенные-json--глубокое-извлечение"> <strong>Вложенные JSON + глубокое извлечение</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#вложенные-json--глубокое-извлечение" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Здесь мы извлекаем вложенные объекты (например, filters внутри event_properties). Жисоны внутри жисонов! Я и такое встречал, правда мне надо было в постгресе с этим работать:</p>
<pre><code>-- Извлекаем вложенные объекты (например, filters внутри event_properties)
SELECT
    event_id,
    JSONExtractString(event_properties, 'event_name') AS event_name,
    -- Извлекаем вложенный объект 'filters' как сырую строку
    JSONExtractRaw(event_properties, 'filters') AS filters_raw,
    -- Далее парсим его из RAW
    JSONExtractString(
        JSONExtractRaw(event_properties, 'filters'),
        'color'
    ) AS color_filter
FROM web_analytics
WHERE JSONExtractString(event_properties, 'event_name') = 'search';
</code></pre>
<p><img src="../../../../attachments/poligon_clickhouse_functions_4.png" width="auto" height="auto" alt/></p>
<p>В запросе смотрим цвета товаров, которые искал юзер.</p>
<h2 id="json_exists--проверка-наличия-ключа"><strong>JSON_EXISTS — Проверка наличия ключа</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#json_exists--проверка-наличия-ключа" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Проверяем, есть ли определённые поля в JSON</p>
<p><code>$.product_id</code> здесь не регулярное выражение, а <strong>JSONPath‑выражение</strong>: путь к полю <code>product_id</code> в JSON‑объекте.​</p>
<ul>
<li><code>$</code> — корень JSON‑документа (весь жысон целиком).​</li>
<li><code>.product_id</code> — ключ <code>product_id</code> на первом уровне внутри этого объекта.</li>
</ul>
<p>В более сложной вложенности (2 уровень) было бы так например:</p>
<p><code>$.product.price</code> — поле <code>price</code> внутри объекта <code>product</code></p>
<pre><code>-- Проверяем, есть ли определённые поля в JSON (используя JSONPath синтаксис)
SELECT
    event_id,
    JSONExtractString(event_properties, 'event_name') AS event_name,
    JSON_EXISTS(event_properties, '$.product_id') AS has_product_id,
    JSON_EXISTS(event_properties, '$.discount_amount') AS has_discount,
    JSON_EXISTS(event_properties, '$.error') AS has_error,
    JSON_EXISTS(user_profile, '$.premium') AS has_premium_flag
FROM web_analytics;

</code></pre>
<p>Из запроса на скрине видно, что мы нашли поле error у event_id 7 (возможное свидетельство ошибок, или остаточный аппендикс в работе сервиса - повод сообщить разрабам!). Ну, или, например, убедились, что во всех JSON есть пометка о премиум статусе и т.д.</p>
<p><img src="../../../../attachments/poligon_clickhouse_functions_5.png" width="auto" height="auto" alt/></p>
<p>Я показал базовую работу с JSON в Clickhouse. Сейчас пока отвлечемся от жисонов и попробуем Еще другие прикольные функции кликхауза со сложными типами данных, но не жисонами!</p>
<p>Я бахну таблицу с 3 колонками. Опять же попробуем симулировать что-то близкое к маркетинговой или продуктовой аналитике: события, юзеры, время событий:</p>
<pre><code>
-- Создаём таблицу с нативным движком для примеров

CREATE TABLE events (

    user_id UInt32,

    event String,

    event_timestamp DateTime

) ENGINE = MergeTree()

ORDER BY (event_timestamp);

  

-- Вставляем тестовые данные с различными типами событий

INSERT INTO events VALUES

(1, 'click', '2025-01-04 10:00:00'),

(1, 'view', '2025-01-04 10:01:00'),

(1, 'add_to_cart', '2025-01-04 10:02:00'),

(1, 'checkout', '2025-01-04 10:03:00'),

(2, 'click', '2025-01-04 10:05:00'),

(2, 'view', '2025-01-04 10:06:00'),

(2, 'click', '2025-01-04 10:07:00'),

(3, 'click', '2025-01-04 10:10:00'),

(3, 'add_to_cart', '2025-01-04 10:11:00'),

(3, 'checkout', '2025-01-04 10:12:00'),

(1, 'purchase', '2025-01-04 10:04:00'),

(2, 'purchase', '2025-01-04 10:08:00');
</code></pre>
<p>Таблицу <span class="text-highlight">events</span> я положил рядом с JSONовой таблицей в папке <span class="text-highlight">clickhouse_sql</span></p>
<h2 id="grouparray-агрегирование-всех-значений-в-массив"><strong>groupArray</strong> — Агрегирование всех значений в массив<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#grouparray-агрегирование-всех-значений-в-массив" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Собираем все события пользователя и их таймстампы в массивы с помощью groupArray.</p>
<pre><code>SELECT
    user_id,
    groupArray(event) AS event_sequence,
    groupArray(event_timestamp) AS timestamps
FROM events
GROUP BY user_id
ORDER BY user_id;
</code></pre>
<p><img src="../../../../attachments/poligon_clickhouse_functions_6.png" width="auto" height="auto" alt/>
Мы смогли сгруппировать у каждого юзера набор событий, который он совершал у нас в продукте. Это может быть полезно в аналитике и статистических моделях. И кликхауз здесь как раз и дает такую возможность.</p>
<p>Далее уже можно будет в следующих трансформациях сортировать по timestamps события у каждого юзера. У нас так получилось только благодаря везению с исходными данными.</p>
<h2 id="array-join-развёртывание-массивов-в-отдельные-строки"><strong>ARRAY JOIN</strong> — “Развёртывание” массивов в отдельные строки<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#array-join-развёртывание-массивов-в-отдельные-строки" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Простой пример:</p>
<pre><code>
SELECT [1, 2, 3] AS nums ARRAY JOIN nums AS num;

</code></pre>
<pre><code>
Результат:

num

1 

2 

3

</code></pre>
<p>Вернемся к events:</p>
<p>Обратная операция к groupArray: превращаем массивы обратно в строки. Берем прошлый запрос и разворачиваем все обратно. Здесь уже сделал код и для того, чтобы расставить ровно события по их времени внутри “сессий” юзера.</p>
<pre><code>SELECT
    user_id,
    event,
    event_index
FROM (
    SELECT
        user_id,
        groupArray(event) AS events,
        arrayEnumerate(groupArray(event)) AS indices
    FROM events
    GROUP BY user_id
)
ARRAY JOIN events AS event, indices AS event_index
ORDER BY user_id, event_index;

-- Результат: каждое событие в отдельной строке с его индексом

</code></pre>
<p>То есть в результирующую колонку event протягиваем “колбасой” элементы массива events, а в evnet_indexes протягиваем индексы из функции <strong>arrayEnumerate</strong>.</p>
<p><code>arrayEnumerate</code>: Эта функция добавляет каждому элементу массива его индекс (позицию) и возвращает массив пар (индекс, значение). Это полезно для анализа последовательности элементов или отслеживания их порядка.
<img src="../../../../attachments/poligon_clickhouse_functions_7.png" width="auto" height="auto" alt/></p>
<p>Запрос развернул нам массивы и пронумеровал события в рамках активности каждого юзера (проведя и сортировку по времени во вложенном запросе, которой не было в прошлый раз)</p>
<h2 id="arraymap-с-lambda-функциями-преобразование-элементов-массива"><strong>arrayMap с lambda-функциями</strong> — Преобразование элементов массива<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#arraymap-с-lambda-функциями-преобразование-элементов-массива" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>В ClickHouse есть три разных сущности: <strong>Map‑тип</strong>, <strong>лямбда‑функции</strong> и <strong>arrayMap</strong> как функция высшего порядка над массивами.</p>
<ul>
<li>
<p><strong><code>Map(K, V)</code></strong> — отдельный тип данных: ассоциативный массив «ключ → значение», например <code>Map(String, Float64)</code> для <code>{&quot;color&quot;: &quot;red&quot;, &quot;price&quot;: 10.5}</code>.</p>
</li>
<li>
<p>Хранится как два параллельных массива (<code>keys</code>, <code>values</code>) внутри колонки и используется, когда у строки может быть разное число пар ключ‑значение (теги, атрибуты и т.п.).</p>
</li>
</ul>
<h2 id="лямбдафункция">Лямбда‑функция<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#лямбдафункция" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li>
<p>Лямбда в ClickHouse — это <strong>анонимная функция</strong>, записывается в виде <code>x -> выражение</code>, например <code>x -> x * 2</code>По сути как и в том же Python, например​</p>
</li>
<li>
<p>Используется в функциях высшего порядка (arrayMap, arrayFilter и т.д.), которые применяют её к элементам массива <code>Array</code>​</p>
</li>
</ul>
<p>Примеры лямбд:</p>
<ul>
<li><code>x -> x * 2</code> — умножить элемент на 2.</li>
<li><code>(name, age) -> concat(name, ' ', toString(age))</code> — функция от двух аргументов.</li>
</ul>
<h2 id="arraymap">arrayMap<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#arraymap" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><code>arrayMap</code> Позволяет применить заданное выражение или функцию к каждому элементу массива. Это полезно для преобразования данных в массиве по определенному правилу.</p>
<p><strong>Синтаксис</strong>: <code>arrayMap(x -> expression, array)</code></p>
<p><code>x</code>: Переменная, представляющая текущий элемент массива.</p>
<p><code>expression</code>: Выражение или функция, применяемая к каждому элементу массива.</p>
<p><code>array</code>: Исходный массив, элементы которого будут преобразованы или, что чаще всего и бывает - имя столбика с массивами.</p>
<p>Пример:</p>
<pre><code>-- Умножить все числа на 2 
SELECT arrayMap(x -> x * 2, [1, 2, 3]) AS res; 
--  Результатом будет массив [2, 4, 6]`
</code></pre>
<h2 id="как-работает-arraymap-с-двумя-массивами">Как работает arrayMap с двумя массивами<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#как-работает-arraymap-с-двумя-массивами" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Общий вид:</p>
<p><code>arrayMap((a, b) -> выражение, arr1, arr2)</code></p>
<ul>
<li>
<p>Берёт <code>arr1</code> и <code>arr2</code> <strong>параллельно</strong>, по одной паре элементов с одинаковым индексом:</p>
<ul>
<li>
<p>шаг 1: <code>(arr1[1], arr2[1])</code></p>
</li>
<li>
<p>шаг 2: <code>(arr1[2], arr2[2])</code></p>
</li>
<li>
<p>и т.д.</p>
</li>
</ul>
</li>
<li>
<p>На каждой паре вызывает, например, лямбду <code>(a, b) -> ...</code> и результат записывает в новый массив.</p>
</li>
</ul>
<p>​
Теперь, узнав основы, посмотрим пример сложнее с таблицей events. Разметим не только индексы событий у каждого юзера, но и посмотрим разницу по времени между событиями у одного юзера (у нас игрушечный пример, везде разница должна быть 60 сек)
<img src="../../../../attachments/poligon_clickhouse_functions_8.png" width="auto" height="auto" alt/></p>
<pre><code>-- arrayMap с lambda-функциями - Преобразование элементов массива, с двумя массивами

WITH user_events AS (

    SELECT

        user_id,

        groupArray(event) AS events,

        groupArray(toUnixTimestamp(event_timestamp)) AS timestamps

    FROM (

        SELECT

            user_id,

            event,

            event_timestamp

        FROM events

        ORDER BY user_id, event_timestamp

    )

    GROUP BY user_id

)

  

SELECT

    user_id,

    events AS original_events,

    arrayEnumerate(events) AS event_positions, -- индексы 1,2,3,...

    arrayMap(

        (ts, i) -> if(i = 1, 0, ts - timestamps[i-1]),

        timestamps,

        arrayEnumerate(timestamps)

    ) AS time_deltas

FROM user_events;
</code></pre>
<p>В нашем случае:</p>
<pre><code>arrayMap(
    (ts, i) -> ...,
    timestamps,                  -- первый массив
    arrayEnumerate(timestamps)   -- второй массив
)
</code></pre>
<p>Значит:</p>
<ul>
<li>
<p>на первом шаге: <code>ts = timestamps[1]</code>, <code>i = 1</code></p>
</li>
<li>
<p>на втором: <code>ts = timestamps[2]</code>, <code>i = 2</code></p>
</li>
<li>
<p>на третьем: <code>ts = timestamps[3]</code>, <code>i = 3</code></p>
</li>
</ul>
<p><code>if(i = 1, 0, ts - timestamps[i-1])</code> -  Если это первый элемент массива в серии событий, то логично, что разница с прошлым будет 0. В остальных случаях считаем разницу по времени <code>ts - timestamps[i-1]</code> с прошлым элементом.</p>
<p><code>toUnixTimestamp(event_timestamp)</code> превращает обе даты во <strong>время в секундах</strong>, и разность двух чисел даёт число в секундах.</p>
<p>Да, тот же результат по дельтам времени можно посчитать оконной функцией <code>lag</code> без arrayMap, но мне хотелось показать работу именно этих Clickhouse функций:)</p>
<h2 id="лямбды-к-словарям-с-фильтрацией-arrayfilter-выбор-только-конверсионных-событий"> <strong>Лямбды к словарям с фильтрацией (arrayFilter)</strong> — Выбор только конверсионных событий<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#лямбды-к-словарям-с-фильтрацией-arrayfilter-выбор-только-конверсионных-событий" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Давайте попробуем еще поиграться с мапами и условиями/фильтрами:</p>
<pre><code>-- Из всех событий выбираем только конверсионные (checkout, purchase)

WITH user_events AS (

SELECT

user_id,

groupArray(event) AS events,

groupArray(event_timestamp) AS timestamps

FROM events

GROUP BY user_id

)

SELECT

user_id,

events AS all_events,

-- Фильтруем только события покупок

arrayFilter(x -> (x = 'checkout' OR x = 'purchase'), events) AS conversion_events,

-- Подсчитываем количество конверсионных событий

length(arrayFilter(x -> (x = 'checkout' OR x = 'purchase'), events)) AS conversion_count

FROM user_events

ORDER BY user_id;
</code></pre>
<p>На скрине выполненного запроса видно, что в conversion_events мы четко отфильтровали и оставили в массиве только нужные нам значения конверсионных событий.</p>
<p>Более того, подсчитав длину массивов с конверсионными событиями можно тут же и посчитать их количество. Удобно!</p>
<p><img src="../../../../attachments/poligon_clickhouse_functions_9.png" width="auto" height="auto" alt/></p>
<p><strong>Давайте теперь поробуем совместить работу с JSON и сложными типами данных! Для этого я сделал таблицу user_journey</strong></p>
<pre><code>-- Таблица user_journey с JSON структурой для хранения событий пользователя

CREATE TABLE user_journey (

user_id UInt32,

events_json String -- JSON массив событий: [{&quot;event_name&quot;: &quot;click&quot;, &quot;event_ts&quot;: &quot;2025-01-04 10:00:00&quot;, &quot;event_value&quot;: 0.5}, ...]

) ENGINE = MergeTree()

ORDER BY user_id;

  

-- Вставляем тестовые данные с JSON событиями

INSERT INTO user_journey VALUES

(1, '[{&quot;event_name&quot;:&quot;click&quot;,&quot;event_ts&quot;:&quot;2025-01-04 10:00:00&quot;,&quot;event_value&quot;:0.5},{&quot;event_name&quot;:&quot;view&quot;,&quot;event_ts&quot;:&quot;2025-01-04 10:01:00&quot;,&quot;event_value&quot;:1.0},{&quot;event_name&quot;:&quot;purchase&quot;,&quot;event_ts&quot;:&quot;2025-01-04 10:04:00&quot;,&quot;event_value&quot;:99.99}]'),

(2, '[{&quot;event_name&quot;:&quot;click&quot;,&quot;event_ts&quot;:&quot;2025-01-04 10:05:00&quot;,&quot;event_value&quot;:0.5},{&quot;event_name&quot;:&quot;click&quot;,&quot;event_ts&quot;:&quot;2025-01-04 10:07:00&quot;,&quot;event_value&quot;:0.5},{&quot;event_name&quot;:&quot;purchase&quot;,&quot;event_ts&quot;:&quot;2025-01-04 10:08:00&quot;,&quot;event_value&quot;:49.99}]'),

(3, '[{&quot;event_name&quot;:&quot;click&quot;,&quot;event_ts&quot;:&quot;2025-01-04 10:10:00&quot;,&quot;event_value&quot;:0.5},{&quot;event_name&quot;:&quot;add_to_cart&quot;,&quot;event_ts&quot;:&quot;2025-01-04 10:11:00&quot;,&quot;event_value&quot;:5.0}]');
</code></pre>
<p>В этой таблице у каждого юзера есть массив событий, их таймстампов и числовых значений. Также есть event_values - пусть это будут условные числовые метрики (в жизни это могут быть веса для статистики, время выполнения события и т.д.)</p>
<h2 id="arrayreduce---агрегация-массивов"><strong>arrayReduce - агрегация массивов</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#arrayreduce---агрегация-массивов" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><strong>Функция</strong> <code>arrayReduce</code>: Применяет агрегатную функцию ко всем элементам массива. Это удобно для выполнения агрегирования данных после их предварительной обработки.</p>
<p><strong>Синтаксис</strong>: <code>arrayReduce('aggregate_function', array)</code></p>
<p><code>aggregate_function</code>: Название агрегатной функции, такой как <code>sum</code>, <code>avg</code>, <code>min</code>, <code>max</code>, <code>uniq</code>, <code>count</code> и другие.</p>
<p><code>array</code>: Массив, к элементам которого применяется агрегатная функция.</p>
<pre><code>WITH user_events AS (

    SELECT

        user_id,

        toFloat32(JSONExtractString(event_json, 'event_value')) AS values

    FROM user_journey

    ARRAY JOIN JSONExtractArrayRaw(events_json) AS event_json

)

SELECT

    user_id,

    groupArray(values) AS event_values,

    -- Сумма через arrayReduce

    arrayReduce('sum', groupArray(values)) AS total_value,

    -- Среднее через arrayReduce

    arrayReduce('avg', groupArray(values)) AS avg_value,

FROM user_events

GROUP BY user_id;
</code></pre>
<p><img src="../../../../attachments/poligon_clickhouse_functions_10.png" width="auto" height="auto" alt/></p>
<p>В запросе также есть еще один примечательный момент - Работа с массивами внутри JSON! event_json — это алиас (псевдоним), созданный в ARRAY JOIN для каждого элемента JSON-массива.</p>
<p>В CTE разворачиваем JSON-массив events_json в строки (помним про вертикальную колбаску!) через ARRAY JOIN JSONExtractArrayRaw(events_json) AS event_json.</p>
<p>В основном запросе группируем по user_id, собираем все числовые значения событий пользователя в массив event_values. Потом считаем сумму всех значений событий пользователя (total_value) и среднее значение событий пользователя (avg_value).</p>
<p>Результат: по одной строке на пользователя с массивом значений его событий, суммой и средним.</p>
<h2 id="mapfromarraysдля-создания-словарей"><strong>mapFromArrays для создания словарей</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#mapfromarraysдля-создания-словарей" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><code>mapFromArrays</code> — это функция в ClickHouse, которая создаёт <strong>Map</strong> (словарь, где есть ключи и значения) из двух массивов: одного массива ключей и одного массива значений.​</p>
<p><strong>Синтаксис:</strong></p>
<p><code>mapFromArrays(ключи, значения)</code></p>
<p><strong>Простой пример:</strong></p>
<p><code>SELECT mapFromArrays(['a', 'b', 'c'], [1, 2, 3])</code></p>
<p><strong>Результат:</strong></p>
<p><code>{'a':1, 'b':2, 'c':3}</code></p>
<p>Попробуем с user_journey:</p>
<pre><code>
-- Создаём словарь событие → количество для каждого пользователя

WITH event_counts AS (

    SELECT

        user_id,

        JSONExtractString(event_json, 'event_name') AS event,

        count() AS cnt

    FROM user_journey

    ARRAY JOIN JSONExtractArrayRaw(events_json) AS event_json

    GROUP BY user_id, event

)

SELECT

    user_id,

    -- Преобразуем результаты в Map (ключ: событие, значение: количество)

    mapFromArrays(

        groupArray(event),

        groupArray(cnt)

    ) AS event_map

FROM event_counts

GROUP BY user_id

ORDER BY user_id;

  

-- Результат: {click: 1, view: 1, purchase: 1} для user_id=1
</code></pre>
<p><img src="../../../../attachments/poligon_clickhouse_functions_11.png" width="auto" height="auto" alt/>
Из двух массивов по событиям и их счетчику получили map  с набором событий и их количеством</p></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div class="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false,&quot;enableRadial&quot;:false}"></div><button class="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div class="global-graph-outer"><div class="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.2,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true,&quot;enableRadial&quot;:true}"></div></div></div><div class="toc desktop-only"><button type="button" class="toc-header" aria-controls="toc-11" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><ul id="list-1" class="toc-content overflow"><li class="depth-0"><a href="#что-делает-mergetree" data-for="что-делает-mergetree">Что делает MergeTree</a></li><li class="depth-0"><a href="#зачем-нужен-order-by" data-for="зачем-нужен-order-by">Зачем нужен ORDER BY</a></li><li class="depth-0"><a href="#jsonextractstring-простое-извлечение-строк" data-for="jsonextractstring-простое-извлечение-строк">JSONExtractString — Простое извлечение строк</a></li><li class="depth-0"><a href="#jsonextract-с-типизацией-извлечение-разных-типов-данных" data-for="jsonextract-с-типизацией-извлечение-разных-типов-данных">JSONExtract с типизацией — Извлечение разных типов данных</a></li><li class="depth-0"><a href="#jsonextractkeysandvaluesraw-парсинг-всех-ключ-значений" data-for="jsonextractkeysandvaluesraw-парсинг-всех-ключ-значений">JSONExtractKeysAndValuesRaw — Парсинг всех ключ-значений</a></li><li class="depth-0"><a href="#вложенные-json--глубокое-извлечение" data-for="вложенные-json--глубокое-извлечение"> Вложенные JSON + глубокое извлечение</a></li><li class="depth-0"><a href="#json_exists--проверка-наличия-ключа" data-for="json_exists--проверка-наличия-ключа">JSON_EXISTS — Проверка наличия ключа</a></li><li class="depth-0"><a href="#grouparray-агрегирование-всех-значений-в-массив" data-for="grouparray-агрегирование-всех-значений-в-массив">groupArray — Агрегирование всех значений в массив</a></li><li class="depth-0"><a href="#array-join-развёртывание-массивов-в-отдельные-строки" data-for="array-join-развёртывание-массивов-в-отдельные-строки">ARRAY JOIN — “Развёртывание” массивов в отдельные строки</a></li><li class="depth-0"><a href="#arraymap-с-lambda-функциями-преобразование-элементов-массива" data-for="arraymap-с-lambda-функциями-преобразование-элементов-массива">arrayMap с lambda-функциями — Преобразование элементов массива</a></li><li class="depth-0"><a href="#лямбдафункция" data-for="лямбдафункция">Лямбда‑функция</a></li><li class="depth-0"><a href="#arraymap" data-for="arraymap">arrayMap</a></li><li class="depth-0"><a href="#как-работает-arraymap-с-двумя-массивами" data-for="как-работает-arraymap-с-двумя-массивами">Как работает arrayMap с двумя массивами</a></li><li class="depth-0"><a href="#лямбды-к-словарям-с-фильтрацией-arrayfilter-выбор-только-конверсионных-событий" data-for="лямбды-к-словарям-с-фильтрацией-arrayfilter-выбор-только-конверсионных-событий"> Лямбды к словарям с фильтрацией (arrayFilter) — Выбор только конверсионных событий</a></li><li class="depth-0"><a href="#arrayreduce---агрегация-массивов" data-for="arrayreduce---агрегация-массивов">arrayReduce - агрегация массивов</a></li><li class="depth-0"><a href="#mapfromarraysдля-создания-словарей" data-for="mapfromarraysдля-создания-словарей">mapFromArrays для создания словарей</a></li><li class="overflow-end"></li></ul></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.5.2</a> © 2026</p><ul><li><a href="https://github.com/jackyzha0/quartz">GitHub</a></li><li><a href="https://discord.gg/cRFFHYye7t">Discord Community</a></li></ul></footer></div></div></body><script type="application/javascript" data-persist="true">function n(){let t=this.parentElement;t.classList.toggle("is-collapsed");let e=t.getElementsByClassName("callout-content")[0];if(!e)return;let l=t.classList.contains("is-collapsed");e.style.gridTemplateRows=l?"0fr":"1fr"}function c(){let t=document.getElementsByClassName("callout is-collapsible");for(let e of t){let l=e.getElementsByClassName("callout-title")[0],s=e.getElementsByClassName("callout-content")[0];if(!l||!s)continue;l.addEventListener("click",n),window.addCleanup(()=>l.removeEventListener("click",n));let o=e.classList.contains("is-collapsed");s.style.gridTemplateRows=o?"0fr":"1fr"}}document.addEventListener("nav",c);
</script><script type="module" data-persist="true">function E(a,e){if(!a)return;function t(o){o.target===this&&(o.preventDefault(),o.stopPropagation(),e())}function n(o){o.key.startsWith("Esc")&&(o.preventDefault(),e())}a?.addEventListener("click",t),window.addCleanup(()=>a?.removeEventListener("click",t)),document.addEventListener("keydown",n),window.addCleanup(()=>document.removeEventListener("keydown",n))}function f(a){for(;a.firstChild;)a.removeChild(a.firstChild)}var m=class{constructor(e,t){this.container=e;this.content=t;this.setupEventListeners(),this.setupNavigationControls(),this.resetTransform()}isDragging=!1;startPan={x:0,y:0};currentPan={x:0,y:0};scale=1;MIN_SCALE=.5;MAX_SCALE=3;cleanups=[];setupEventListeners(){let e=this.onMouseDown.bind(this),t=this.onMouseMove.bind(this),n=this.onMouseUp.bind(this),o=this.onTouchStart.bind(this),r=this.onTouchMove.bind(this),i=this.onTouchEnd.bind(this),s=this.resetTransform.bind(this);this.container.addEventListener("mousedown",e),document.addEventListener("mousemove",t),document.addEventListener("mouseup",n),this.container.addEventListener("touchstart",o,{passive:!1}),document.addEventListener("touchmove",r,{passive:!1}),document.addEventListener("touchend",i),window.addEventListener("resize",s),this.cleanups.push(()=>this.container.removeEventListener("mousedown",e),()=>document.removeEventListener("mousemove",t),()=>document.removeEventListener("mouseup",n),()=>this.container.removeEventListener("touchstart",o),()=>document.removeEventListener("touchmove",r),()=>document.removeEventListener("touchend",i),()=>window.removeEventListener("resize",s))}cleanup(){for(let e of this.cleanups)e()}setupNavigationControls(){let e=document.createElement("div");e.className="mermaid-controls";let t=this.createButton("+",()=>this.zoom(.1)),n=this.createButton("-",()=>this.zoom(-.1)),o=this.createButton("Reset",()=>this.resetTransform());e.appendChild(n),e.appendChild(o),e.appendChild(t),this.container.appendChild(e)}createButton(e,t){let n=document.createElement("button");return n.textContent=e,n.className="mermaid-control-button",n.addEventListener("click",t),window.addCleanup(()=>n.removeEventListener("click",t)),n}onMouseDown(e){e.button===0&&(this.isDragging=!0,this.startPan={x:e.clientX-this.currentPan.x,y:e.clientY-this.currentPan.y},this.container.style.cursor="grabbing")}onMouseMove(e){this.isDragging&&(e.preventDefault(),this.currentPan={x:e.clientX-this.startPan.x,y:e.clientY-this.startPan.y},this.updateTransform())}onMouseUp(){this.isDragging=!1,this.container.style.cursor="grab"}onTouchStart(e){if(e.touches.length!==1)return;this.isDragging=!0;let t=e.touches[0];this.startPan={x:t.clientX-this.currentPan.x,y:t.clientY-this.currentPan.y}}onTouchMove(e){if(!this.isDragging||e.touches.length!==1)return;e.preventDefault();let t=e.touches[0];this.currentPan={x:t.clientX-this.startPan.x,y:t.clientY-this.startPan.y},this.updateTransform()}onTouchEnd(){this.isDragging=!1}zoom(e){let t=Math.min(Math.max(this.scale+e,this.MIN_SCALE),this.MAX_SCALE),n=this.content.getBoundingClientRect(),o=n.width/2,r=n.height/2,i=t-this.scale;this.currentPan.x-=o*i,this.currentPan.y-=r*i,this.scale=t,this.updateTransform()}updateTransform(){this.content.style.transform=`translate(${this.currentPan.x}px, ${this.currentPan.y}px) scale(${this.scale})`}resetTransform(){let t=this.content.querySelector("svg").getBoundingClientRect(),n=t.width/this.scale,o=t.height/this.scale;this.scale=1,this.currentPan={x:(this.container.clientWidth-n)/2,y:(this.container.clientHeight-o)/2},this.updateTransform()}},T=["--secondary","--tertiary","--gray","--light","--lightgray","--highlight","--dark","--darkgray","--codeFont"],y;document.addEventListener("nav",async()=>{let e=document.querySelector(".center").querySelectorAll("code.mermaid");if(e.length===0)return;y||=await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.esm.min.mjs");let t=y.default,n=new WeakMap;for(let r of e)n.set(r,r.innerText);async function o(){for(let s of e){s.removeAttribute("data-processed");let c=n.get(s);c&&(s.innerHTML=c)}let r=T.reduce((s,c)=>(s[c]=window.getComputedStyle(document.documentElement).getPropertyValue(c),s),{}),i=document.documentElement.getAttribute("saved-theme")==="dark";t.initialize({startOnLoad:!1,securityLevel:"loose",theme:i?"dark":"base",themeVariables:{fontFamily:r["--codeFont"],primaryColor:r["--light"],primaryTextColor:r["--darkgray"],primaryBorderColor:r["--tertiary"],lineColor:r["--darkgray"],secondaryColor:r["--secondary"],tertiaryColor:r["--tertiary"],clusterBkg:r["--light"],edgeLabelBackground:r["--highlight"]}}),await t.run({nodes:e})}await o(),document.addEventListener("themechange",o),window.addCleanup(()=>document.removeEventListener("themechange",o));for(let r=0;r<e.length;r++){let v=function(){let g=l.querySelector("#mermaid-space"),h=l.querySelector(".mermaid-content");if(!h)return;f(h);let w=i.querySelector("svg").cloneNode(!0);h.appendChild(w),l.classList.add("active"),g.style.cursor="grab",u=new m(g,h)},M=function(){l.classList.remove("active"),u?.cleanup(),u=null},i=e[r],s=i.parentElement,c=s.querySelector(".clipboard-button"),d=s.querySelector(".expand-button"),p=window.getComputedStyle(c),L=c.offsetWidth+parseFloat(p.marginLeft||"0")+parseFloat(p.marginRight||"0");d.style.right=`calc(${L}px + 0.3rem)`,s.prepend(d);let l=s.querySelector("#mermaid-container");if(!l)return;let u=null;d.addEventListener("click",v),E(l,M),window.addCleanup(()=>{u?.cleanup(),d.removeEventListener("click",v)})}});
</script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript" data-persist="true"></script><script src="../../../../postscript.js" type="module" data-persist="true"></script></html>